<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta property="og:site_name" content="Tree Shade Interface">
        <meta property="og:title" content="Layout Auto Generating" />
        <meta property="og:description" content="Adobe InDesign and Adobe Bridge Tree Shade Extension Interface." />
        <meta property="og:image" itemprop="image" content="<TS_Preview>">
        <meta property="og:type" content="website" />
        <meta property="og:updated_time" content="1440432930" />
        <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
        <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <style>
            @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:200,300,400);
            .fa {
                padding-top: 5px;
                padding-bottom: 5px;
                font-size: 20px;
                text-align: center;
                text-decoration: none;
                margin: 2px 2px;
            }
            .fa:hover {
                opacity: 0.7;
            }

            .fa-facebook {
                color: white;
                width:100%;
            }

            .fa-twitter {
                color: white;
                width:100%;
            }

            .fa-linkedin {
                color: white;
                width:100%;
            }

            .fa-youtube {
                color: white;
                width:100%;
            }

            .fa-instagram {
                color: white;
                width:100%;
            }

            .fa-pinterest {
                color: white;
                width:100%;
            }
            textarea {
            resize: vertical;
            }

            /* Center the loader */
            .loader {
                z-index: 1;
                width: 120px;
                height: 120px;
                margin-top: 0px;
                margin-right: auto;
                margin-bottom: 32px;
                margin-left: auto;
                border: 16px solid #f3f3f3;
                border-radius: 50%;
                border-top: 16px solid lightskyblue;
                -webkit-animation: spin 2s linear infinite;
                animation: spin 2s linear infinite;
            }

            .wrapper {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }

            .fa-external-link {
            animation: coolFlash 1.5s ease-in-out 3;
            display: inline-block; /* Needed for transform to work correctly */
            }

            @keyframes coolFlash {
                0%, 100% {
                    transform: scale(1);
                    opacity: 1;
                }
                30% {
                    transform: scale(1.6);
                    opacity: 0.7;
                }
                60% {
                    transform: scale(0.95);
                    opacity: 0.9;
                }
            }


            .newSubKey {
                color: #ff1493;
            }

            .header {
                padding-top: 30px;
                width: 100%;
                margin-bottom: 60px;
            }

            .header > div {
                max-width: 1000px;
                margin: auto;
                margin-bottom: -7px;
                width: 90%;
            }

            #btns {
                margin-bottom: 60px;
            }

            .footer {
                display: none;
                padding: auto;
                padding-bottom: 60px;
                width: 100%;
                margin-top: auto;
            }

            .footer > div {
                max-width: 1000px;
                margin: auto;
                width: 90%;
            }

            @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
            }

            @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
            }

            /* Add animation to "page content" */
            .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
            }

            @-webkit-keyframes animatebottom {
            from { bottom:-100px; opacity:0 } 
            to { bottom:0px; opacity:1 }
            }

            @keyframes animatebottom { 
            from{ bottom:-100px; opacity:0 } 
            to{ bottom:0; opacity:1 }
            }

            * {
            box-sizing: border-box;
            }

            html {
            background: rgb(241, 241, 241);
            color: #fff;
            font-family: 'Yanone Kaffeesatz', sans-serif;
            }

            .timer-group {
            height: 400px;
            margin: 0 auto;
            position: relative;
            width: 400px;
            }

            .timer {
            border-radius: 50%;
            height: 100px;
            overflow: hidden;
            position: absolute;
            width: 100px;
            }

            .timer:after {
            background: rgb(241, 241, 241);
            border-radius: 50%;
            content: "";
            display: block;
            height: 80px;
            left: 5px;
            position: absolute;
            width: 80px;
            top: 5px;
            }

            .timer .hand {
            float: left;
            height: 100%;
            overflow: hidden;
            position: relative;
            width: 50%;
            }

            .timer .hand span {
            border: 50px solid lightseagreen;
            border-bottom-color: transparent;
            border-left-color: transparent;
            border-radius: 50%;
            display: block;
            height: 0;
            position: absolute;
            right: 0;
            top: 0;
            transform: rotate(225deg);
            width: 0;
            }

            .timer .hand:first-child {
            transform: rotate(180deg);
            }

            .timer .hand span {
            animation-duration: 4s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
            }

            .timer .hand:first-child span {
            animation-name: spin1;
            }

            .timer .hand:last-child span {
            animation-name: spin2; 
            }

            .timer.hour {
            height: 400px;
            left: 0;
            width: 400px;
            top: 0;
            }

            .timer.hour .hand span {
                animation-duration: 3600s;
                border-top-color: lightseagreen;
                border-right-color: lightseagreen;
                border-width: 200px;
            }

            .timer.hour:after {
                height: 360px;
                left: 20px;
                width: 360px;
                top: 20px;
            }

            .timer.minute {
                height: 350px;
                left: 25px;
                width: 350px;
                top: 25px;
            }

            .timer.minute .hand span {
                animation-duration: 60s;
                border-right-color: lightseagreen;
                border-width: 175px;
            }

            .timer.minute:after {
                height: 310px;
                left: 20px;
                width: 310px;
                top: 20px;
            }

            .timer.second {
                height: 300px;
                left: 50px;
                width: 300px;
                top: 50px;
            }

            .timer.second .hand span {
                animation-duration: 1s;
                border-top-color: lightgrey;
                border-right-color: lightgrey;
                border-width: 150px;
            }

            .timer.second:after {
                height: 296px;
                left: 2px;
                width: 296px;
                top: 2px;
            }

            .face {
                border-radius: 50%;
                height: 296px;
                left: 52px;
                padding: 150px 30px 0;
                position: absolute;
                width: 296px;
                text-align: center;
                top: 52px;
            }

            #btns {
                z-index: 4;
            }

            .face h2 {
                font-size: 20px;
            }

            .face p {
                border-radius: 20px;
                font-size: 50px;
                font-weight: 400;
                position: absolute;
                top: 17px;
                width: 260px;
                left: 20px;
            }

            @keyframes spin1 {
                0% {
                    transform: rotate(225deg);
                }
                50% {
                    transform: rotate(225deg);
                }
                100% {
                    transform: rotate(405deg);
                }
            }

            @keyframes spin2 {
                0% {
                    transform: rotate(225deg);
                }
                50% {
                    transform: rotate(405deg);
                }
                100% {
                    transform: rotate(405deg);
                }
            }

            .ultimate {
                display: flex;
                transition: all 0.3s ease;
                height: 100vh; /* Ensure the parent container fills the viewport */
            }

            #previewFrame {
                width: 100%;
                height: 100%;
            }

            .leftside {
                width: 100%; /* Full width by default */
                height: 100vh;
                background-color: #f0f0f0;
                border-right: 3px solid ghostwhite;
                overflow: auto;
                transition: all 0.3s ease; /* Smooth width transitions */
            }

            #pagemodal {
                width: 100%; /* Full width by default */
                height: 100vh;
                overflow: auto;
                z-index: 1000;
                padding: 20px;
            }

            .rightside {
                position: fixed;
                top: 0;
                right: 0;
                width: 50%; /* Width of the right side when visible */
                height: 100vh;
                background-color: #e0e0e0;
                border-left: 3px solid gray;
                overflow: auto;
                z-index: 1000;
                visibility: hidden; /* Hidden by default */
                opacity: 0; /* Fully transparent by default */
                transition: all 0.3s ease; /* Smooth visibility and opacity */
            }

            .hideright .rightside {
                visibility: hidden; /* Hide the right side */
                opacity: 0; /* Fully transparent */
            }

            .hideright .leftside {
                width: 100%; /* Expand the left side to full width */
            }

            .hideright #pagemodal {
                width: 100%;
            }

            .showright .rightside {
                visibility: visible; /* Show the right side */
                opacity: 1; /* Fully opaque */
            }

            .showright .leftside {
                width: 50%; /* Shrink the left side to half width */
            }

            .showright #pagemodal {
                width: 50%;
            }

            .optionImg {
                width: 100%;
                aspect-ratio: 1 / 1;
                object-fit: contain;
            }

            .verticalText {
                writing-mode: vertical-lr; 
                transform: rotate(360deg);
                margin: auto;
                margin-top: 10px;
                font-size: 10px !important;
            }

            .optionCon:hover {
                box-shadow: 0 0 2px 1px rgba(0, 140, 186, 0.5);
            }

            .optionCon {
                border: 1px solid lightgray;
                padding: 5px;
                width: 100%;
            }

            .selectedOptionCon {
                border: 3px solid lightseagreen;
            }

            .selectedOptionfake {
                border: 3px solid orange;
            }

            .optionText {
                font-family: Verdana, Geneva, Tahoma, sans-serif;
                font-size: small;
            }

            .optionContent {
                display: none;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
                font-size: small;
            }

            .docCon {
                width: 100%;
                display: grid;
                grid-template-areas:
                'left right right right right';
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
                margin-bottom: 10px;
            }

            .pagesCon {
                grid-area: right;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                z-index: 3;
            }

            .docTitleCon {
                grid-area: left;
                width: 100%;
                z-index: 3;
            }

            .pageThumb {
                width: 100%;
            }

            .pageImage {
                width: 100%;
                border: 1px solid lightgray;
            }

            .downloadImageButton {
                display: block;
                margin-top: 10px;
                margin-bottom: 20px;
            }

            .optionsCon {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(auto-fit, 32px);
                gap: 5px;
                direction: rtl;
            }

            .theFrame {
                border: 1px solid teal;
                border-radius: 8px;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .coordinatesFrame {
                border: 3px solid red;
                border-radius: 3px;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .theColFrame {
                border-top: 1px solid gray;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .listItemFrame {
                border-top: 0px solid gray;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .awesomeIcon {
                margin: auto;
                transform: scale(1.1, 1.1);
            }

            .awesomeArrow {
                margin: auto;
                transform: scale(1.5, 1.5);
            }

            .mainLabel {
                z-index: 3;
            }

            .mainItem1 {
                grid-area: topleft;
                border-bottom: 0px solid teal;
                padding-top: 3px;
                padding-right: 5px;
                padding-bottom: 3px;
                margin-bottom: 8px;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0px;
            }

            .mainItem2 {
                grid-area: topright;
                padding-top: 3px;
                padding-bottom: 3px;
                margin-bottom: 8px;
                z-index: 1;
                display: flex;
                align-items: center; /* Align items vertically in the center */
            }

            .greenStrip {
                padding-left: 5px;
            }

            .mainItem3 {
                grid-area: bottomleft;
                margin-bottom: 8px;
                padding-right: 5px;
            }

            .mainItemDownCol {
                grid-area: bottomleft;
                border-bottom: 0px solid teal;
                padding-top: 3px;
                padding-right: 0px;
                padding-bottom: 3px;
                margin-bottom: 8px;
                display: grid;
                grid-template-columns: repeat(1, 1fr);
                gap: 0px;
            }

            .mainItemDown {
                grid-area: bottomleft;
                border-bottom: 0px solid teal;
                padding-top: 3px;
                padding-right: 5px;
                padding-bottom: 3px;
                margin-bottom: 8px;
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 0px;
                z-index: 1;
            }

            .mainItem4 {
                grid-area: bottomright;
                margin-bottom: 8px;
                z-index: 1;
            }

            .mainItem5 {
                grid-area: pocket;
            }

            @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
            }

            .blinking {
                animation: blink 1s infinite;
            }
            
            .topSelectedOption {
                display: flex;
                align-items: center;
                margin-left: auto;
            }

            .topSelectedOption > .optionImg {
                padding: 5px;
                height: 32px;
                width: 32px;
                margin-left: 5px;
            }

            .topSelectedOption > .optionText {
                margin-left: 5px;
            }
            .topSelectedOption > .optionContent {
                margin-left: 5px;
            }

            .lonelyCon {
                margin-top: 0px !important;
                margin-bottom: 0px !important;
                padding-top: 0px !important;
            }

            .staticHead {
                display: none;
            }

            .subHTMLCon {
                display: none !important;
            }

            .mainCon {
                display: grid;
                grid-template-areas:
                'topleft topright topright topright topright'
                'bottomleft bottomright bottomright bottomright bottomright'
                'pocket pocket pocket pocket pocket';
                grid-template-columns: repeat(5, 1fr);
                gap: 0px;
                margin-bottom: 8px;
                padding-top: 8px;
            }

            .colItemCon {
                padding-left: 5px;
            }

            .mainColCon {
                display: grid;
                grid-template-areas:
                'topright topright topright topright topright'
                'bottomright bottomright bottomright bottomright bottomright'
                'pocket pocket pocket pocket pocket';
                grid-template-columns: repeat(5, 1fr);
                gap: 0px;
                margin-bottom: 8px;
                padding-top: 8px;
            }

            .listItemCon {
                display: grid;
                grid-template-areas:
                'topleft topright topright topright topright'
                'bottomleft bottomright bottomright bottomright bottomright'
                'pocket pocket pocket pocket pocket';
                grid-template-columns: repeat(5, 1fr);
                gap: 0px;
                margin-top: 0px;
                margin-bottom: 0px;
                padding-top: 0px;
            }

            .topHidden {
                display: none;
            }

            .dynamicLiveSnippetMain {
                display: none;
            }

            .toDeleteBeforeSubmit {
                display: none;
            }

            .removedByUser {
                display: none;
            }

            .removedByCaller {
                display: none;
            }

            .toBeHidden {
                display: none;
            }

            .lonelyHidden {
                display: none;
            }

            .oneOption {
                display: none;
                opacity: 1;
            }

            .fakeOption {
                display: none;
            }

            .collapsed {
                display: none;
            }

            .collapsedOptions {
                display: none;
            }

            .noCollapse {
                display: none;
            }

            .uploadName {
                padding: 5px;
                width: 50%;
            }

            .diagonalStripes {
                width: 100%;
                height: 100%;
                border: 1px solid #d7d7d7;
                padding: 5px;
                background: repeating-linear-gradient(
                    45deg,
                    #e6e6e6,
                    #e6e6e6 15px,
                    #f4f4f4 15px,
                    #f4f4f4 30px
                    );
            }

            .staticText {
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }

            .fileCon {
                width: 100%;
                height: 130px;
            }

            .tinyThumb {
                z-index: 5;
                height: 30px;
                margin-left: auto;
            }

            .tinyImage {
                height: 100%;
            }
            
            .tinyImage:hover {
                height: 100%;
                transform-origin: bottom;
                transform: scale(5) translate(-40%, 0);
            }

            .uploadFileCon {
                height: 100%;
                padding: 5px;
            }

            .uploadFileCon > * {
                max-width: 100%;
                max-height: 100%;
            }

            .pageModalThumb {
                margin-top: 20px;
            }

            .modalX {
                font-weight: bold;
                mix-blend-mode: difference;
                color: white; /* Default color */
            }

            input[type="file"] {
                text-indent: -999em;
                outline: none;
                width: 100%;
                height: 100%;
            }
            .CodeMirror .cm-header-1 {
            font-size: 1.4em;
            font-weight: bold;
            }

            .CodeMirror .cm-header-2 {
            font-size: 1.2em;
            font-weight: bold;
            }

            .CodeMirror .cm-header-3 {
            font-size: 1.1em;
            font-weight: bold;
            }

            .CodeMirror .cm-header-4,
            .CodeMirror .cm-header-5,
            .CodeMirror .cm-header-6 {
            font-size: 1em;
            font-weight: bold;
            }

        </style>
        <script>
        function previewFrameLoad(previewFrame) {
            if (previewFrame.contentWindow.document.body) {
                const childDocument = previewFrame.contentWindow.document;
                const fieldElements = childDocument.querySelectorAll('[data-fi]');
                let lastContainer = null;

                fieldElements.forEach((element) => {
                    let hideTimeout;
                    element.style.pointerEvents = 'none';
                    const computedStyle = window.getComputedStyle(element);
                    if (computedStyle.position === 'static') {
                        element.style.position = 'relative';
                    }

                    const tsFrame = childDocument.createElement('div');
                    tsFrame.classList.add('ts-frame');
                    tsFrame.style.position = 'absolute';
                    tsFrame.style.width = '102%'; 
                    tsFrame.style.height = '102%'; 
                    tsFrame.style.top = '-1%';
                    tsFrame.style.left = '-1%';
                    tsFrame.style.border = '1px solid rgba(0, 100, 255, 0)';
                    tsFrame.style.backgroundColor = 'rgba(0, 100, 255, 0)';
                    tsFrame.style.boxSizing = 'border-box';
                    tsFrame.style.borderTop = 'none';
                    tsFrame.style.pointerEvents = 'auto';

                    const container = childDocument.createElement('div');
                    container.classList.add('ts-button-container');
                    container.style.position = 'absolute';
                    container.style.transform = 'translateY(-100%)';
                    container.style.display = 'none';
                    container.style.backgroundColor = 'rgba(0, 100, 255)';
                    container.style.boxSizing = 'border-box';
                    container.style.direction = 'ltr';
                    container.style.textAlign = 'left';
                    container.style.width = 'fit-content';
                    container.style.whiteSpace = 'nowrap';

                    const editButton = childDocument.createElement('button');
                    editButton.textContent = 'Reveal';
                    editButton.classList.add('ts-edit-button'); 
                    editButton.style.margin = '3px';
                    editButton.style.marginRight = '0px';
                    editButton.style.border = 'none';
                    editButton.style.direction = 'ltr';
                    editButton.style.textAlign = 'left';

                    const markButton = childDocument.createElement('button');
                    markButton.textContent = 'Mark';
                    markButton.classList.add('ts-mark-button'); 
                    markButton.style.margin = '3px';
                    markButton.style.marginRight = '0px';
                    markButton.style.border = 'none';
                    markButton.style.direction = 'ltr';
                    markButton.style.textAlign = 'left';

                    const copyPathButton = childDocument.createElement('button');
                    copyPathButton.textContent = 'Path';
                    copyPathButton.classList.add('ts-copy-path-button');
                    copyPathButton.style.margin = '3px'; 
                    copyPathButton.style.marginRight = '0px';
                    copyPathButton.style.border = 'none';
                    copyPathButton.style.direction = 'ltr';
                    copyPathButton.style.textAlign = 'left';

                    const copyTextButton = childDocument.createElement('button');
                    copyTextButton.textContent = 'Text';
                    copyTextButton.classList.add('ts-copy-text-button');
                    copyTextButton.style.margin = '3px';
                    copyTextButton.style.border = 'none';
                    copyTextButton.style.direction = 'ltr';
                    copyTextButton.style.textAlign = 'left';

                    container.appendChild(editButton);
                    container.appendChild(markButton);
                    container.appendChild(copyPathButton);
                    container.appendChild(copyTextButton);

                    tsFrame.appendChild(container);

                    element.insertBefore(tsFrame, element.firstChild);

                    element.addEventListener('mouseleave', () => {
                        tsFrame.style.display = 'block'; // Restore its visibility
                    });

                    tsFrame.addEventListener('click', (event) => {
                        if (!container.contains(event.target)) {
                            // Look for a true parent field outside the current element
                            const parentField = element.parentElement.closest('[data-fi]');

                            // If a parent field exists, activate its tsFrame instead
                            if (parentField) {
                                const parentTsFrame = parentField.querySelector('.ts-frame');
                                if (parentTsFrame) {
                                    parentTsFrame.dispatchEvent(new Event('mouseenter')); // Activate parent tsFrame
                                }
                            }

                            // Default behavior: hide the clicked tsFrame
                            tsFrame.style.display = 'none'; // Hide the tsFrame
                            tsFrame.style.border = '1px solid rgba(0, 100, 255, 0)';
                            element.style.pointerEvents = 'auto';
                        }
                    });

                    tsFrame.addEventListener('mouseenter', () => {
                        tsFrame.style.border = '1px solid rgba(0, 100, 255, 1)';
                        container.style.display = 'block';
                        if (lastContainer && lastContainer !== container) {
                            lastContainer.style.display = 'none'; // Hiding the previous container
                            const lastTsFrame = lastContainer.closest('.ts-frame'); // Find the associated tsFrame
                            if (lastTsFrame) {
                                lastTsFrame.style.border = '1px solid rgba(0, 100, 255, 0)'; // Hide its border
                            }
                            lastContainer = null;
                        }
                        lastContainer = container;
                        if (hideTimeout) clearTimeout(hideTimeout);
                    });

                    tsFrame.addEventListener('mouseleave', () => {
                        hideTimeout = setTimeout(() => {
                            tsFrame.style.border = '1px solid rgba(0, 100, 255, 0)';
                            container.style.display = 'none';
                        }, 500);
                    });

                    container.addEventListener('mouseenter', () => {
                        if (hideTimeout) clearTimeout(hideTimeout);
                        container.style.display = 'block';
                    });

                    container.addEventListener('mouseleave', () => {
                        hideTimeout = setTimeout(() => {
                            tsFrame.style.border = '1px solid rgba(0, 100, 255, 0)';
                            container.style.display = 'none';
                        }, 500);
                    });

                    editButton.addEventListener('click', () => {
                        const fieldIdentifier = element.getAttribute('data-fi');
                        if (fieldIdentifier && typeof parent.goToField === 'function') {
                            parent.goToField(fieldIdentifier);
                        }
                    });

                    markButton.addEventListener('click', () => {
                        if (tsFrame.style.backgroundColor != 'rgba(0, 255, 100, 0.3)') {
                            tsFrame.style.backgroundColor = 'rgba(0, 255, 100, 0.3)';
                            markButton.textContent = 'Unmark';
                        }
                        else {
                            tsFrame.style.backgroundColor = '';
                            markButton.textContent = 'Mark';
                        }
                    });

                    copyPathButton.addEventListener('click', () => {
                        const fieldIdentifier = element.getAttribute('data-fi');
                        if (fieldIdentifier) {
                            navigator.clipboard.writeText(fieldIdentifier).then(() => {
                                copyPathButton.innerHTML = 'Copied';
                                copyPathButton.style.backgroundColor = 'green';
                                copyPathButton.style.color = 'white';
                                setTimeout(() => {
                                    copyPathButton.innerHTML = 'Path';
                                    copyPathButton.style.backgroundColor = '';
                                    copyPathButton.style.color = '';
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy text: ', err);
                            });
                        }
                    });
                    copyTextButton.addEventListener('click', () => {
                        // Function to recursively get direct visible text from descendants
                        function getVisibleText(element) {
                            const computedStyle = window.getComputedStyle(element);

                            // Skip invisible elements
                            if (computedStyle.display === 'none') return '';

                            // Skip elements with the .ts-frame class
                            if (element.classList.contains('ts-frame')) return '';

                            // Check if the element has meaningful text nodes
                            const hasMeaningfulText = Array.from(element.childNodes).some(node =>
                                node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0
                            );

                            if (hasMeaningfulText) {
                                // Return the trimmed textContent of the element if it has meaningful text
                                return element.textContent.trim();
                            }

                            // Recursively process direct children, separating results by "\r"
                            return Array.from(element.children)
                                .map(child => getVisibleText(child)) // No need to trim here
                                .filter(text => text.length > 0) // Exclude empty results
                                .join('\n'); // Combine with "\r" as a separator
                        }

                        // Get the combined visible text starting from the root element
                        const visibleText = getVisibleText(element).trim(); // Apply final trim to clean up leading/trailing spaces

                        // Copy the combined text if any is found
                        if (visibleText) {
                            navigator.clipboard.writeText(visibleText).then(() => {
                                copyTextButton.innerHTML = 'Copied';
                                copyTextButton.style.backgroundColor = 'green';
                                copyTextButton.style.color = 'white';
                                setTimeout(() => {
                                    copyTextButton.innerHTML = 'Text';
                                    copyTextButton.style.backgroundColor = '';
                                    copyTextButton.style.color = '';
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy text: ', err);
                            });
                        } else {
                            console.warn('No visible text to copy.');
                        }
                    });
                });
            }
        }
        </script>
    </head>
<body onload="load()">
    <div class="ultimate hideright" id="ultimateContainer">
        <div id="pagemodal" class="w3-modal" onclick="closeIfBackgroundClicked(event, this)">
            <div class="w3-modal-content">
                <div class="w3-container">
                    <span onclick="closePageModel(this)" class="modalX w3-button w3-display-topright">&times;</span>
                    <div class="pageModalThumb"></div>
                    <button class="w3-button w3-tiny w3-teal downloadImageButton" onclick="downloadImage (this)">Download</button>
                </div>
            </div>
        </div>
        <div class="leftside">
            <div class="wrapper">
                <div id="crop-modal" class="w3-modal">
                    <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width:600px">
                        <div class="w3-center w3-padding-16 w3-margin"><br>
                            <span onclick="cropDone()" class="w3-button w3-display-topright w3-blue-grey">&times;</span>
                            <!-- A canvas which cropper will draw on -->
                            <div class="w3-container w3-border w3-margin w3-padding-32">
                            <canvas id="crop-canvas" width="300" height="300">Your browser does not support
                                canvas.</canvas>
                            </div>
                            <!-- Below are a series of inputs which allow file selection and interaction with the cropper api -->
                            <div class="w3-button w3-round w3-teal w3-margin-bottom" onclick="cropperStartCropping()">Start cropping</div>
                            <div class="w3-button w3-round w3-teal w3-margin-bottom" onclick="cropperGetCroppedImageSrc()">Crop</div>
                            <div class="w3-button w3-round w3-teal w3-margin-bottom" onclick="cropperRestore()">Restore</div>
                        </div>
                    </div>
                </div>
        
                <div id="id01" class="w3-modal" style="padding-top: 300px;">
                    <div class="w3-modal-content">
                    <div class="w3-container">
                        <div class="loader"></div>
                    </div>
                    </div>
                </div>
                <div class="header w3-teal">
                    <div>
                        <h2>Auto Design Templates</h2>
                    </div>
                    <div class="w3-cell-row w3-blue-grey">
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-facebook"></a></div>
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-twitter"></a></div>
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-linkedin"></a></div>
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-youtube"></a></div>
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-instagram"></a></div>
                        <div class="w3-container w3-cell"><a href="#" class="fa fa-pinterest"></a></div>
                    </div>
                </div>
                <div class="w3-light-grey" id="main-block" style="display: none; max-width:1000px; width: 80%; margin:auto">
                    <div class="w3-light-grey w3-col s12 m12 l12">
                        <div class="w3-padding-16">
                            <div class="w3-animate-opacity timer-group" id="timer-show" style="display: none;">
                                <div class="timer hour">
                                    <div class="hand"><span></span></div>
                                    <div class="hand"><span></span></div>
                                </div>
                                <div class="timer minute">
                                    <div class="hand"><span></span></div>
                                    <div class="hand"><span></span></div>
                                </div>
                                <div class="timer second">
                                    <div class="hand"><span></span></div>
                                    <div class="hand"><span></span></div>
                                </div>
                                <div class="face">
                                    <h2>It'll take a couple minutes.</h2>
                                    <p id="lazy">00:00:00</p>  
                                </div>
                            </div>
                            <div class="w3-row w3-row-padding w3-center" id="stop-wait" style="display: none;">
                                <div class="w3-panel w3-pale-yellow w3-border">
                                    <p>Producing the design takes long. Please copy the url and save it for later.</p>
                                </div>
                                <div class="w3-button w3-round w3-teal" onclick="reload(this)" style="margin: 4px;">Reload</div>
                            </div>
                            <div class="w3-animate-top" id="output" style="display: none;">
                                <TS_Thumbs>
                            </div>
                        </div>
                    </div>
                    <div class="w3-animate-top w3-padding-16 w3-col s12 m12 l12" id="form-div" style="display: none;">
                        <form action="" method="POST" enctype="multipart/form-data" onsubmit="showLoader()" id="form-main">
                            <div class="w3-row" id="before-stars">
                                <div class="w3-col s12 m12 l12">
                                    <TS_Fields>
                                    <input type="hidden" id="submit-btn" name="submit_btn" value="">
                                </div>
                                <div id="btns" class="w3-col s12 m12 l12">
                                    <br><hr class="w3-border-green"><br>
                                    <div style="width: 100%; height: 120px;">
                                        <div id="btnsLoader" style="width: 100%; height: 100%; display: none;">
                                            <div class="loader"></div>
                                        </div>
                                    </div>
                                    <div class="w3-row w3-right">
                                        <TS_Buttons>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div id="optionsforms" style="display: none;">
                        <div id="submit-option-div">
                            <form target="iframe_placeholder_id" action="/submit_new_option" method="POST" enctype="multipart/form-data" id="submit-option-form">
                                <input type="hidden" name="submit_option_name" value="">
                                <input type="hidden" name="paired_folder" value="">
                                <input type="hidden" name="flags" value="">
                                <input type="hidden" name="locationhref" value="">
                            </form>
                            <iframe name="iframe_placeholder_id" id="iframe_placeholder_id"></iframe>
                        </div>
                    </div>
                </div>
                <footer class="footer w3-container w3-teal" id="footer">
                    <div>
                        <p>Tree Shade Interface</p>
                        <p>Version 9.3.7</p>
                    </div>
                </footer>
            </div>        
        </div>
        <div class="rightside">
            <iframe id="previewFrame" src="" frameborder="0" onload="previewFrameLoad(this)"></iframe>
        </div>
    </div>
    <script>
        var toUploadImage = null;
        var ID0SolveMainList = [];
        var defaults = {}
        , one_second = 1000
        , one_minute = one_second * 60
        , one_hour = one_minute * 60
        , one_day = one_hour * 24
        , startDate = new Date()
        , face = document.getElementById('lazy');
        // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
        var requestAnimationFrame = (function() {
        return window.requestAnimationFrame       || 
                window.webkitRequestAnimationFrame || 
                window.mozRequestAnimationFrame    || 
                window.oRequestAnimationFrame      || 
                window.msRequestAnimationFrame     || 
                function( callback ){
                window.setTimeout(callback, 1000 / 60);
                };
        }());
        tick();
        function tick() {
            var now = new Date()
                , elapsed = now - startDate
                , parts = [];
            parts[0] = '' + Math.floor( elapsed / one_hour );
            parts[1] = '' + Math.floor( (elapsed % one_hour) / one_minute );
            parts[2] = '' + Math.floor( ( (elapsed % one_hour) % one_minute ) / one_second );
            parts[0] = (parts[0].length == 1) ? '0' + parts[0] : parts[0];
            parts[1] = (parts[1].length == 1) ? '0' + parts[1] : parts[1];
            parts[2] = (parts[2].length == 1) ? '0' + parts[2] : parts[2];
            face.innerText = parts.join(':');
            requestAnimationFrame(tick);
        }
        function openPageModel (pageThumbEle) {
            var pageModalEle = document.getElementById('pagemodal');
            var pageModalThumbEle = pageModalEle.getElementsByClassName ("pageModalThumb");
            if (pageModalThumbEle.length > 0) {
                pageModalThumbEle[0].innerHTML = pageThumbEle.innerHTML;
            }
            pageModalEle.style.display='block';
        }
        function closePageModel(element) {
            const modal = element.closest('.w3-modal');
            if (modal) modal.style.display = 'none';
        }
        function closeIfBackgroundClicked(event, modal) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }        
        function goToField(fieldIdentifier) {
            var mainEle = document.querySelector(`[data-identifier="${fieldIdentifier}"]`);
            if (mainEle) {
                var mainMainEle = document.getElementById('main_trsd_main');
                collapseAllChilds (mainMainEle, true);
                collapseWithParents (mainEle, false);
                collapseAllChilds (mainEle, false);
                setTimeout(() => scrollToElementCenter(mainEle, 300), 300);
            }
        }

        function scrollToElementCenter(theEle, duration) {
            if (!theEle) return;
            let scrollContainer = theEle.parentElement;
            while (scrollContainer && getComputedStyle(scrollContainer).overflow === "visible") {
                scrollContainer = scrollContainer.parentElement;
            }
            if (!scrollContainer) scrollContainer = document.documentElement;
            var mi1 = document.getElementById (theEle.id.replace ("main_", "mi1_"));
            if (mi1) {
                theTriangleEle = mi1.getElementsByClassName ("awesomeArrow");
                if (theTriangleEle.length > 0) {
                    const triangleIcon = theTriangleEle[0];
                    triangleIcon.classList.add('blinking');
                    setTimeout(() => {
                        triangleIcon.classList.remove('blinking');
                    }, 3000);
                }
            }
            const startY = scrollContainer.scrollTop;
            const elementRect = theEle.getBoundingClientRect();
            const containerRect = scrollContainer.getBoundingClientRect();
            const targetY =
                elementRect.top - containerRect.top + scrollContainer.scrollTop - scrollContainer.clientHeight / 2;
            const startTime = performance.now();
            function scrollStep(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const scrollY = startY + (targetY - startY) * progress;

                scrollContainer.scrollTo({
                    top: scrollY,
                    behavior: "auto",
                });

                if (progress < 1) {
                    requestAnimationFrame(scrollStep);
                }
            }
            requestAnimationFrame(scrollStep);
        }

        function openTheWebPage(theBtn) {
            var pageURL = theBtn.getAttribute("data-url");
            var ultimate = document.getElementById("ultimateContainer");
            var previewFrame = document.getElementById("previewFrame");

            ultimate.classList.toggle("hideright"); // Toggle hideright class
            ultimate.classList.toggle("showright"); // Toggle showright class

            if (ultimate.classList.contains("hideright")) {
                // Right side hidden
                theBtn.innerHTML = "Open the Web Page";
                if (previewFrame) {
                    previewFrame.src = ""; // Clear iframe content
                }
            } else {
                // Right side visible
                if (pageURL) {
                    theBtn.innerHTML = "Close the Web Page";
                    if (previewFrame) {
                        previewFrame.src = pageURL; // Load the iframe content
                    }
                }
            }
        }

        function downloadImage (buttonEle) {
            var pageModalThumbEle = buttonEle.previousElementSibling;
            if (pageModalThumbEle) {
                var pageImageEle = pageModalThumbEle.firstChild;
                if (pageImageEle) {
                    var link = document.createElement("a");
                    link.href = pageImageEle.src;
                    link.download = pageImageEle.getAttribute ("data-downname");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }
        function showLoader() {
            document.getElementById('id01').style.display='block';
        }
        function stopWaiting() {
            document.getElementById ("stop-wait").style.display='block';
            document.getElementById('timer-show').style.display='none';
            window.stop();
        }
        function reload () {
            location.replace (location.href.replace (/\?Producing&?/i, ""));
            location.reload();
        }
        function load () {
            //<TS_KEYPATH_REPLACESTATE>
            var theForm = document.getElementById('form-main');
            if (theForm) {
                theForm.setAttribute ("action", "https://" + location.host + location.pathname + location.search);
            }
            var theOpForm = document.getElementById('submit-option-form');
            if (theOpForm) {
                theOpForm.setAttribute ("action", location.protocol + "//" + location.host + "/submit_new_option");
            }
            if (location.href.search (/\?Producing/i) != -1) {
                document.getElementById ("main-block").style.display='block';
                document.getElementById('timer-show').style.display='block';
                location.replace (location.href.replace (/\?Producing/i, "?Produced"));
                setTimeout(stopWaiting, 120000);
            }
            else if (location.href.indexOf ("?Produced") != -1) {
                location.replace (location.href.replace (/\?Produced&?/i, ""));
            }
            else {
                document.getElementById ("main-block").style.display='block';
                if (document.getElementById('output').innerHTML.indexOf ("<TS_Thumbs>") == -1) {
                    document.getElementById('output').style.display='block';
                }
                if (document.getElementById('before-stars').innerHTML.indexOf ("<TS_Fields>") == -1) {
                    document.getElementById('form-div').style.display='block';
                    document.getElementById('footer').style.display='block';
                }
            }
            var theMainOptEle = document.getElementById("op_trsd_main");
            if (theMainOptEle) {
                goOptionsSubmit (theMainOptEle.id, false);
            }
        }
        function switchDone (isOn) {
            if (isOn) {
                //Sprout new elements
                var sproutEles = document.getElementsByClassName ("sprout");
                for (var ses = 0; ses < sproutEles.length; ses++) {
                    if (sproutEles[ses].tagName.toLowerCase() === 'a') {
                        sproutEles[ses].classList.remove ("sprout");
                        sproutEles[ses].click();
                    }
                }
            }
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle) {
                if (isOn) {
                    btnsLoaderEle.style.display = 'none';
                }
                else {
                    btnsLoaderEle.style.display = 'block';
                }
            }
            var btnsEle = document.getElementById ("btns");
            if (btnsEle) {
                var allBtnsEles = btnsEle.getElementsByClassName ("downButton");
                for (var abs = 0; abs < allBtnsEles.length; abs++) {
                    if (isOn) {
                        allBtnsEles[abs].classList.remove ("w3-disabled");
                    }
                    else {
                        allBtnsEles[abs].classList.add ("w3-disabled");
                    }
                }
            }
            if (isOn) {
                for (var ism = ID0SolveMainList.length - 1; ism >= 0; ism--) {
                    var inputEle = document.getElementById (ID0SolveMainList[ism].id.replace ("main_", "in_"));
                    if (ID0SolveMainList[ism].classList.contains ("subKeyMain")) {
                        var newEle = cloneItemFromInput (inputEle);
                        if (newEle) {
                            newEle.classList.remove ("tsroItem");
                            var mi2 = document.getElementById (newEle.id.replace ("main_", "mi2_"));
                            if (mi2) {
                                var renamableInputEle = mi2.getElementsByClassName ("renamable");
                                if (renamableInputEle.length > 0) {
                                    renamableInputEle[0].removeAttribute('readonly');
                                }
                            }
                            var mi4 = document.getElementById (newEle.id.replace ("main_", "mi4_"));
                            if (mi4.classList.contains ("oneOption")) {
                                triggerOneOption (newEle);
                            }
                        }
                    }
                    else {
                        newItemFromInput (inputEle);
                    }
                    removeMainEle (ID0SolveMainList[ism]);
                }
                ID0SolveMainList = [];
            }
        }
        function blobToFile (theBlob, fileName) {
            //A Blob() is almost a File() - it's just missing the two properties below which we will add
            theBlob.lastModifiedDate = new Date();
            theBlob.name = fileName;
            return theBlob;
        }
        function cropDone () {
            toUploadImage.src = cropperGetCroppedImageSrc ();
            var dt = new DataTransfer();
            document.getElementById('crop-modal').style.display='none';
        }
        function frameParent (mainEle, level) {
            var expectedParent = mainEle.parentElement;
            while (expectedParent && (!expectedParent.classList.contains ('mainCon') || expectedParent.classList.contains ('lonelyCon'))) {
                expectedParent = expectedParent.parentElement;
            }
            if (expectedParent) {
                if (!expectedParent.classList.contains ('mainColCon')) {
                    level++;
                    var oldLevel = 0;
                    var oldOutlined = expectedParent.getAttribute ("data-level");
                    if (oldOutlined) {
                        oldLevel = parseInt (oldOutlined);
                    }
                    if (level > oldLevel) {
                        expectedParent.setAttribute ("data-level", level);
                        if (expectedParent.children.length > 0) {
                            var theFrameEle = expectedParent.children[0];
                            theFrameEle.style.width = (100 + (2 * level)) + "%";
                            theFrameEle.style.borderRadius = (3 * level) + "px";
                        }
                        frameParent (expectedParent, level);
                    }
                }
            }
        }
        function collapseWithParents (mainEle, isToCollapse) {
            var mi1 = document.getElementById (mainEle.id.replace ("main_", "mi1_"));
            if (mi1) {
                theTriangleEle = mi1.getElementsByClassName ("awesomeArrow");
                if (theTriangleEle.length > 0) {
                    collapse (theTriangleEle[0], isToCollapse);
                }
            }
            var expectedParent = mainEle.parentElement;
            while (expectedParent && !expectedParent.classList.contains ('mainCon')) {
                expectedParent = expectedParent.parentElement;
            }
            if (expectedParent) {
                collapseWithParents (expectedParent, isToCollapse);
            }
        }
        function collapseAllChilds (mainEle, isToCollapse) {
            var elements = null;
            if (isToCollapse) {
                elements = mainEle.querySelectorAll('.fa-caret-down');
            }
            else {
                elements = mainEle.querySelectorAll('.fa-caret-right');
            }
            const visibleElements = Array.from(elements).filter(element => {
              return window.getComputedStyle(element.parentElement).display !== 'none';
            });
            visibleElements.forEach(element => {
                collapse (element, isToCollapse);
            });
        }
        function goSubmit (theBtn) {
            var itemsParent = document.getElementById ("before-stars");
            if (itemsParent) {
                if (theBtn.getAttribute ("data-void") == "yes") {
                    allMainCon = itemsParent.getElementsByClassName ("mainCon");
                    for (var amc = 0; amc < allMainCon.length; amc++) {
                        var theInputID = allMainCon[amc].id.replace ("main_", "in_");
                        var theInput = document.getElementById (theInputID);
                        if (theInput) {
                            theInput.removeAttribute("name");
                        }
                    }
                    var renameEles = itemsParent.getElementsByClassName ("renamable");
                    for (var rnm = renameEles.length - 1; rnm >= 0; rnm--) {
                        renameEles[rnm].remove ();
                    }
                }
                else {
                    var renameEles = itemsParent.getElementsByClassName ("renamable");
                    for (var rnm = renameEles.length - 1; rnm >= 0; rnm--) {
                        if (renameEles[rnm].getAttribute ("data-original") == renameEles[rnm].value) {
                            renameEles[rnm].remove ();
                        }
                    }
                    var allMainOriginal = itemsParent.getElementsByClassName ("mainOriginal");
                    for (var mo = 0; mo < allMainOriginal.length; mo++) {
                        var theInputID = allMainOriginal[mo].id.replace ("main_", "in_");
                        var theInput = document.getElementById (theInputID);
                        if (theInput && theInput.getAttribute ("data-key")) {
                            theInput.removeAttribute("name");
                            break;
                        }
                    }
                    var allMainCon = itemsParent.getElementsByClassName ("mainCon");
                    var sortLists = [];
                    var toBeRemovedList = [];
                    for (var i = 0; i < allMainCon.length; i ++) {
                        if (allMainCon[i].classList.contains ("toDeleteBeforeSubmit") || allMainCon[i].classList.contains ("removedByUser") || allMainCon[i].classList.contains ("removedByCaller")) {
                            if (allMainCon[i].classList.contains("autoLoaded")) {
                                var theInputID = allMainCon[i].id.replace ("main_", "in_");
                                var theInputEle = document.getElementById (theInputID);
                                if (theInputEle) {
                                    if (theInputEle.type == "file") {
                                        theInputEle.opacity = 0;
                                        theInputEle.type = "text";
                                    }
                                    if (allMainCon[i].classList.contains ("toDeleteBeforeSubmit")) {
                                        theInputEle.name += "_trsd_clean";
                                    }
                                    else {
                                        theInputEle.name += "_trsd_delete";
                                    }
                                }
                            }
                            else {
                                toBeRemovedList.push (i);
                            }
                        }
                        else {
                            var mi4 = document.getElementById (allMainCon[i].id.replace ("main_", "mi4_"));
                            var theSelectedEle = mi4.getElementsByClassName ("selectedOptionCon");
                            if (theSelectedEle.length > 0) {
                                theSelectedEle = theSelectedEle[0];
                                if (true) { //theSelectedEle.getAttribute("data-sort") == "yes"
                                    sortLists.push ([theSelectedEle.id, null, []]);
                                }
                            }
                            var theInputEle = document.getElementById (allMainCon[i].id.replace ("main_", "in_"));
                            if (theInputEle) {
                                if (theInputEle.type == "file") {
                                    if (theInputEle.files.length == 0) {
                                        theInputEle.type = "text";
                                        theInputEle.value = theInputEle.getAttribute ("data-copying");
                                    }
                                }
                                else {
                                    var dataDynamic = theInputEle.getAttribute ("data-dynamic");
                                    if (dataDynamic) {
                                        allMainCon[i].classList.add ("dynamicLiveSnippetMain");
                                        theInputEle.value = dataDynamic + ":\n" + theInputEle.value;
                                    }
                                }
                            }
                        }
                    }
                    for (var tbr = toBeRemovedList.length - 1; tbr >= 0; tbr--) {
                        allMainCon[toBeRemovedList[tbr]].remove ();
                    }
                    allMainCon = itemsParent.getElementsByClassName ("mainCon");
                    var thumbInputHTML = '';
                    for (var amc = 0; amc < allMainCon.length; amc++) {
                        var theThumbID = allMainCon[amc].id.replace ("main_", "thumb_");
                        var theThumbEle = document.getElementById (theThumbID);
                        var thePath = '';
                        var theName = null;
                        var newExt = '';
                        var sortListIndex = -1;
                        var isToAddToSort = false;
                        var isToAddThumb = false;
                        var parentOptionID = getCallerOptionID (allMainCon[amc]);
                        if (parentOptionID) {                            
                            for (var si = 0; si < sortLists.length; si++) {
                                if (sortLists[si][0] == parentOptionID) {
                                    sortListIndex = si;
                                    isToAddToSort = true;
                                    break;
                                }
                            }
                        }
                        if (theThumbEle) {
                            if (theThumbEle.src && theThumbEle.src.indexOf ("/Workshop/") != -1) {
                                isToAddThumb = true;
                            }
                        }
                        var theInputEle = document.getElementById (allMainCon[amc].id.replace ("main_", "in_"));
                        if (!theInputEle) {
                            continue;
                        }
                        if (isToAddToSort || isToAddThumb) {
                            if (theInputEle.type == "file") {
                                if (theInputEle.files.length > 0) {
                                    var file = theInputEle.files[0];
                                    if (file.name.indexOf ('.') != -1) {
                                        newExt = file.name.slice (file.name.lastIndexOf ('.') + 1);
                                    }
                                }
                            }
                            else if (theInputEle.value.indexOf ("op_") == 0) {
                                if (theInputEle.value != "op_empty") {
                                    if (theInputEle.value.indexOf ("_dot_") != -1) {
                                        newExt = theInputEle.value.slice (theInputEle.value.lastIndexOf ("_dot_") + 5);
                                    }
                                }
                            }
                            else {
                                newExt = 'txt';
                            }
                            theName = allMainCon[amc].id.replace ("main_", "");
                            if (theName.indexOf ("_slash_") != -1) {
                                thePath = theName.slice (0, theName.lastIndexOf ("_slash_") + 7);
                                theName = theName.slice (theName.lastIndexOf ("_slash_") + 7);
                            }
                            if (theName.indexOf ("_dot_") != -1) {
                                theName = theName.slice (0, theName.lastIndexOf ("_dot_"));
                            }
                            var renameInput = document.getElementById (allMainCon[amc].id.replace ("main_", "rnm_in_"));
                            if (renameInput && renameInput.value != '') {
                                var theNewName = renameInput.value;
                                theNewName = theNewName.replace(/ /g, '_space_').replace(/\./g, '_dot_');
                                if (theName.search (/[^\[\]]\[[^\[]+\]$/) != -1) {
                                    theName = theName.replace (/\[[^\[\]]+\]$/, '[' + theNewName + ']');
                                }
                                else {
                                    theName += '_space_[' + theNewName + ']';
                                }
                            }
                        }
                        if (isToAddToSort) {
                            if (sortLists[sortListIndex][1] == null) {
                                sortLists[sortListIndex][1] = "in_" + thePath + "ts_sort_dot_txt";
                            }
                            var pureName = theName;
                            if (newExt == '') {
                                pureName += "_dot_fake";
                            }
                            else {
                                pureName += "_dot_" + newExt;
                            }
                            pureName = pureName.replace (/_space_/g, " ").replace(/_dot_/g, '.');
                            pureName = getPureName (pureName, false);
                            sortLists[sortListIndex][2].push (pureName);
                        }
                        if (isToAddThumb) {
                            var inputName = thePath + "_dot_TREESHADE_slash__dot_THUMB_slash_" + theName + "_dot_" + newExt + "_dot_jpg";
                            var srcPath = decodeURI (theThumbEle.src);
                            srcPath = srcPath.slice (srcPath.indexOf ("/Workshop/") + 10);
                            var fileName = srcPath.slice (srcPath.lastIndexOf ("/") + 1).replace(/ /g, '_space_').replace(/\./g, '_dot_');
                            var filePath = srcPath.slice (0, srcPath.lastIndexOf ("/")).replace(/\//g, '_slash_').replace(/ /g, '_space_').replace(/\./g, '_dot_');
                            var inputValue = "op__trsd_option_sep_" + filePath + "_trsd_option_sep_" + fileName;
                            thumbInputHTML += '<input type="hidden" name="in_' + inputName + '" value="' + inputValue + '">';
                        }
                    }
                    //sortLists
                    if (sortLists.length > 0) {
                        var sortInputHTML = '';
                        for (var sls = 0; sls < sortLists.length; sls++) {
                            if (sortLists[sls][2].length > 1) {
                                var sortInputValue = sortLists[sls][2].join ("\n");
                                sortInputHTML += '<input type="hidden" name="' + sortLists[sls][1] + '" value="' + sortInputValue + '">';
                                
                            }
                        }
                        if (sortInputHTML != '') {
                            itemsParent.insertAdjacentHTML ("beforeend", sortInputHTML);
                        }
                    }
                    if (thumbInputHTML != '') {
                        itemsParent.insertAdjacentHTML ("beforeend", thumbInputHTML);
                    }
                }
            }
            document.getElementById('submit-btn').value = theBtn.innerHTML;
            document.getElementById('form-main').submit();
        }
        function getCallerOptionID (mainEle) {
            if (mainEle.parentElement.classList.contains ('listCon')) {
                return mainEle.parentElement.parentElement.id.replace ('pocket_', 'op_');
            }
            else {
                return mainEle.parentElement.id.replace ('pocket_', 'op_');
            }
        }
        function getPureName (pureName, isToRemoveID) {
            if (pureName.indexOf (".") != -1) {
                pureName = pureName.slice (0, pureName.lastIndexOf ("."));
            }
            var testName = pureName;
            testName = pureName.replace (/\s*\[[^\]]*\]\s*/g, "");
            if (testName == '') {
                return pureName;
            }
            else {
                pureName = testName;
            }
            if (isToRemoveID) {
                testName = pureName.replace (/(\s?)(ts)(_\w+)+/g, "");
                if (testName == '') {
                    return pureName;
                }
                else {
                    pureName = testName;
                }
            }
            else {
                testName = pureName.replace (/(\s?)(ts)(?!_id)(_\w+)+/g, "");
                if (testName == '') {
                    return pureName;
                }
                else {
                    pureName = testName;
                }
            }
            testName = pureName.replace (/^-\s*/, "");
            if (testName == '') {
                return pureName;
            }
            else {
                pureName = testName;
            }
            return pureName;
        }
        function getPureDisplayName (pureName) {
            if (pureName.indexOf (".") != -1) {
                pureName = pureName.slice (0, pureName.lastIndexOf ("."));
            }
            var testName = pureName;
            if (testName.search (/[^\[\]]\[[^\[\]]+\]$/) != -1) {
                testName = testName.match (/[^\[\]]\[[^\[\]]+\]$/)[0].slice (2, -1);
                if (testName != '') {
                    return testName;
                }
                else {
                    testName = pureName;
                }
            }
            testName = pureName.replace (/\s*\[[^\]]*\]\s*/g, "");
            if (testName == '') {
                return pureName;
            }
            else {
                pureName = testName;
            }
            testName = pureName.replace (/(\s?)(ts)(_\w+)+/g, "");
            if (testName == '') {
                return pureName;
            }
            else {
                pureName = testName;
            }
            testName = pureName.replace (/^-\s*/, "");
            if (testName == '') {
                return pureName;
            }
            else {
                pureName = testName;
            }
            return pureName;
        }
        function orderShift (theEle, direction) {
            var theMainEle = theEle.parentElement.parentElement;
            if (direction == 'Down') {
                var nextEle = theMainEle.nextSibling;
                while (nextEle) {
                    if (nextEle.classList.contains ("removedByUser")) {
                        nextEle = nextEle.nextSibling;
                    }
                    else {
                        break;
                    }
                }
                if (nextEle) {
                    nextEle.insertAdjacentElement("afterend", theMainEle);
                    rearrange (theMainEle);
                }
            }
            else {
                var previousEle = theMainEle.previousSibling;
                while (previousEle) {
                    if (previousEle.classList.contains ("removedByUser")) {
                        previousEle = previousEle.previousSibling;
                    }
                    else {
                        break;
                    }
                }
                if (previousEle) {
                    theMainEle.parentElement.insertBefore (theMainEle, previousEle);
                    rearrange (theMainEle);
                }
            }
        }
        function removeMain (theEle) {
            var theMainEle = theEle.parentElement.parentElement;
            if (countList (theMainEle) > 1) {
                var mi2 = document.getElementById (theMainEle.id.replace ("main_", "mi2_"));
                if (mi2) {
                    var renamableInputEle = mi2.getElementsByClassName ("renamable");
                    if (renamableInputEle.length > 0 && renamableInputEle[0].hasAttribute('readonly')) {
                        return false;
                    }
                }
                removeMainEle (theMainEle);
            }
        }
        function removeMainEle (theMainEle) {
            theMainEle.classList.add ("removedByUser");
            var mi4 = document.getElementById (theMainEle.id.replace ("main_", "mi4_"));
            var allOptCon = mi4.getElementsByClassName("optionCon");
            for (var ao = 0; ao < allOptCon.length; ao++) {
                setFollowing (allOptCon[ao], false, "removedByCaller", false);
            }
            rearrange (theMainEle);
        }
        function triggerOneOption (theMainEle) {      
            var mi4 = document.getElementById (theMainEle.id.replace ("main_", "mi4_"));
            var allOptCon = mi4.getElementsByClassName("optionCon");
            for (var ao = 0; ao < allOptCon.length; ao++) {
                if (allOptCon[ao].classList.contains ("fakeOption")) {
                    optionClicked (allOptCon[ao], true);
                }
            }
        }
        function changeOrder (theOrderEle, theMainEle, newOrderOrShift) {
            if (theMainEle == null) {
                theMainEle = theOrderEle.parentElement.parentElement;
            }
            var currentOrder = 1;
            var thePrefixEle = document.getElementById (theMainEle.id.replace ("main_", "prefix_"));
            if (thePrefixEle) {
                var thePrefix = thePrefixEle.innerHTML;
                currentOrder = parseInt (thePrefix.slice(0, -2), 10);
            }
            if (newOrderOrShift == null) {
                newOrderOrShift = prompt ("New Order:");
            }
            if (newOrderOrShift) {
                var shiftIsPositive = null;
                if (newOrderOrShift.search (/^[+-]/) == 0) {
                    if (newOrderOrShift.search (/^\+/) == 0) {
                        shiftIsPositive = true;
                    }
                    else {
                        shiftIsPositive = false;
                    }
                    newOrderOrShift = newOrderOrShift.slice (1);
                }
                newOrderOrShift = parseInt (newOrderOrShift, 10);
                var newOrder = newOrderOrShift;
                if (shiftIsPositive) {
                    newOrder = currentOrder + newOrderOrShift;
                }
                else if (shiftIsPositive === false) {
                    newOrder = currentOrder - newOrderOrShift;
                }
                if (newOrder > currentOrder) {
                    var diff = newOrder - currentOrder;
                    while (diff--) {
                        var nextEle = theMainEle.nextSibling;
                        while (nextEle) {
                            if (nextEle.classList.contains ("removedByUser")) {
                                nextEle = nextEle.nextSibling;
                            }
                            else {
                                break;
                            }
                        }
                        if (nextEle) {
                            if (nextEle.classList.contains ("tsroAloneItem")) {
                                theMainEle.parentElement.insertBefore (theMainEle, nextEle);
                            }
                            else {
                                nextEle.insertAdjacentElement("afterend", theMainEle);
                            }
                            rearrange (theMainEle);
                        }
                        else {
                            break;
                        }
                    }
                }
                else {
                    var diff = currentOrder - newOrder;
                    while (diff--) {
                        var previousEle = theMainEle.previousSibling;
                        while (previousEle) {
                            if (previousEle.classList.contains ("removedByUser")) {
                                previousEle = previousEle.previousSibling;
                            }
                            else {
                                break;
                            }
                        }
                        if (previousEle) {
                            theMainEle.parentElement.insertBefore (theMainEle, previousEle);
                            rearrange (theMainEle);
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        function duplicateField (thePlusEle) {
            var theMainEle = thePlusEle.parentElement.parentElement;
            var theInputEle = document.getElementById (theMainEle.id.replace ("main_", "in_"));
            newItemFromInput (theInputEle);
        }
        function cloneField (thePlusEle) {
            var theMainEle = thePlusEle.parentElement.parentElement;
            var theInputEle = document.getElementById (theMainEle.id.replace ("main_", "in_"));
            var newEle = cloneItemFromInput (theInputEle);
            if (newEle && newEle.classList.contains ("tsroItem")) {
                newEle.classList.remove ("tsroItem");
                if (newEle.classList.contains ("tsroAloneItem")) {
                    newEle.classList.remove ("tsroAloneItem");
                }
                var mi1NewEle = document.getElementById (newEle.id.replace ("main_", "mi1_"));
                if (mi1NewEle) {
                    var theNewPlusEle = mi1NewEle.getElementsByClassName ("fa-plus-circle");
                    if (theNewPlusEle.length > 0) {
                        theNewPlusEle[0].outerHTML = "<div></div>";
                    }
                }

                var mi2 = document.getElementById (newEle.id.replace ("main_", "mi2_"));
                if (mi2) {
                    var renamableInputEle = mi2.getElementsByClassName ("renamable");
                    if (renamableInputEle.length > 0) {
                        if (renamableInputEle[0].hasAttribute('readonly')) {
                            renamableInputEle[0].removeAttribute('readonly');
                        }
                    }
                }
                changeOrder (null, newEle, "-1");
                if (!thePlusEle.classList.contains ("notLoadedYet")) {
                    triggerOneOption (newEle);
                }
                else {
                    if (mi1NewEle) {
                        theTriangleEle = mi1NewEle.getElementsByClassName ("awesomeArrow");
                        if (theTriangleEle.length > 0) {
                            collapse (theTriangleEle[0], null);
                        }
                    }
                }
            }
        }
        function mi2Collapse (theMi2Ele) {
            var mi1 = document.getElementById (theMi2Ele.id.replace ("mi2_", "mi1_"));
            if (mi1) {
                theTriangleEle = mi1.getElementsByClassName ("awesomeArrow");
                if (theTriangleEle.length > 0) {
                    collapse (theTriangleEle[0], null);
                }
            }
        }
        function moveToTinyThumb (theEle) {
            var theMainEle = theEle.parentElement.parentElement;
            var mi3 = document.getElementById (theMainEle.id.replace ("main_", "mi3_"));
            if (mi3.children.length > 0 && mi3.children[0].src) {
                var mi2 = document.getElementById (theMainEle.id.replace ("main_", "mi2_"));
                if (mi2) {
                    var theTinyThumbEle = mi2.getElementsByClassName ("tinyThumb");
                    if (theTinyThumbEle.length > 0) {
                        theTinyThumbEle[0].innerHTML = '<img class = "tinyImage" src="' + mi3.children[0].src + '"></img>';
                        mi3.innerHTML = "";
                    }
                }
            }
        }
        function collapse (theEle, isToCollapse) {
            var theMainEle = theEle.parentElement.parentElement;
            var mi3 = document.getElementById (theMainEle.id.replace ("main_", "mi3_"));
            var mi4 = document.getElementById (theMainEle.id.replace ("main_", "mi4_"));
            var mi5 = document.getElementById (theMainEle.id.replace ("main_", "mi5_"));
            if (isToCollapse == null) {
                isToCollapse = theEle.classList.contains ("fa-caret-down");
            }
            else {
                if (isToCollapse == false && theEle.classList.contains ("fa-caret-down")) {
                    return true;
                }
                if (isToCollapse == true && !theEle.classList.contains ("fa-caret-down")) {
                    return true;
                }
            }
            if (isToCollapse) {
                if (theMainEle.classList.contains ("mainColCon")) {
                    return false;
                }
                if (theEle.style.display == "none") {
                    return false;
                }
                theEle.classList.remove ("fa-caret-down");
                theEle.classList.add ("fa-caret-right");
                mi3.classList.add ("collapsed");
                mi4.classList.add ("collapsed");
                mi5.classList.add ("collapsed");
            }
            else {
                if (theMainEle.classList.contains ("tsroItem")) {
                    return false;
                }
                if (theMainEle.classList.contains("autoLoaded") && theMainEle.classList.contains("subKeyMain")) {
                    return false;
                }
                theEle.classList.remove ("fa-caret-right");
                theEle.classList.add ("fa-caret-down");
                if (false) {
                    mi3.classList.add ("collapsed");
                }
                else {
                    mi3.classList.remove ("collapsed");
                }
                mi4.classList.remove ("collapsed");
                mi5.classList.remove ("collapsed");
                var testedOptionID = theEle.getAttribute ("data-optionid");
                if (testedOptionID) {
                    var subkeyOptionEle = document.getElementById (testedOptionID);
                    if (subkeyOptionEle) {
                        optionClicked (subkeyOptionEle, true);
                    }
                    theEle.removeAttribute ("data-optionid");
                    var thePlusEle = theEle.parentElement.getElementsByClassName ("fa-plus-circle");
                    if (thePlusEle.length > 0) {
                        thePlusEle[0].classList.remove ("notLoadedYet");
                    }
                }
            }
        }
        function goOptionsSubmit (optionID, isActualClick) {
            switchDone (false);
            var optionPockectEle = document.getElementById (optionID.replace ("op_", "pocket_"));
            optionPockectEle.innerHTML = "<div class='w3-padding w3-row w3-padding' id='" + optionID.replace ("op_", "spinner_") + "'><div class='w3-display-container w3-padding w3-border-top w3-col s12 m12 l12 w3-text-teal'><div class='w3-display-middle'><i class='fa fa-circle-o-notch w3-spin w3-margin-large'></i></div></div></div>";
            var theMessage = optionID;
            if (optionID == "op_trsd_main") {
                var purePathName = location.pathname;
                if (purePathName.indexOf ("/Workshop/") == 0) {
                    purePathName = purePathName.replace ("/Workshop", "");
                }
                purePathName = purePathName.slice (1);
                if (purePathName.search (/ts_pass_[A-Za-z0-9]+$/) != -1) {
                    purePathName = purePathName.slice (0, purePathName.lastIndexOf ("/"));
                }
                theMessage = "op_" + "_trsd_option_sep_" + purePathName.replace(/\//g, '_slash_').replace(/ /g, '_space_').replace(/\./g, '_dot_') + "_trsd_option_sep_";
                theMessage = decodeURI (theMessage);
            }
            var divID = optionID.replace ("op_", "div_");
            var formID = optionID.replace ("op_", "form_");
            var iframeID = optionID.replace ("op_", "iframe_");
            var submitOptionEle = document.getElementById ('submit-option-div');
            var newNode = submitOptionEle.cloneNode (true);
            var toRepeat = newNode.outerHTML;
            toRepeat = toRepeat.replace (/submit-option-div/g, divID);
            toRepeat = toRepeat.replace (/submit-option-form/g, formID);
            toRepeat = toRepeat.replace (/iframe_placeholder_id/g, iframeID);
            submitOptionEle.parentElement.insertBefore (newNode, submitOptionEle.nextSibling);
            var newEle = submitOptionEle.nextSibling;
            newEle.outerHTML = toRepeat;

            document.getElementById (iframeID).addEventListener( "load", function(e) {
                document.getElementById(this.id.replace ("iframe_", "spinner_")).remove ();
                var optionPockectEle = document.getElementById (this.id.replace ("iframe_", "pocket_"));
                optionPockectEle.insertAdjacentHTML("beforeend", this.contentWindow.document.body.innerHTML);
                this.contentWindow.document.body.innerHTML = "";
                var optionEle = document.getElementById (this.id.replace ("iframe_", "op_"));
                var mainParentEle = optionEle.parentElement.parentElement.parentElement;
                if (optionEle.classList.contains("selectedOptionCon") && !mainParentEle.classList.contains('toDeleteBeforeSubmit')) {
                    setFollowing (optionEle, true, "toDeleteBeforeSubmit", false);
                }
                var subItems = optionPockectEle.getElementsByClassName ("mainCon");
                var subArr = [];
                for (var sis = 0; sis < subItems.length; sis++) {
                    subArr.push (subItems[sis]);
                }
                var isActualClick = optionEle.getAttribute ("data-isactualclick");
                for (var sis = 0; sis < subArr.length; sis++) {
                    var scannedMainEle = subArr[sis];
                    var mi1 = document.getElementById (scannedMainEle.id.replace ("main_", "mi1_"));
                    var mi2 = document.getElementById (scannedMainEle.id.replace ("main_", "mi2_"));
                    var mi3 = document.getElementById (scannedMainEle.id.replace ("main_", "mi3_"));
                    var mi4 = document.getElementById (scannedMainEle.id.replace ("main_", "mi4_"));
                    if (mainParentEle.classList.contains ("mainColCon")) {
                        if (!scannedMainEle.classList.contains ("mainColCon")) {
                            scannedMainEle.classList.add ("mainColCon");
                            var theFrameEle = scannedMainEle.children[0];
                            if (theFrameEle && theFrameEle.classList.contains ("theFrame")) {
                                theFrameEle.classList.remove ("theFrame");
                                theFrameEle.classList.add ("theColFrame");
                            }
                            if (mi1) {
                                mi1.style.display = 'none';
                            }
                            if (mi3) {
                                mi3.style.display = 'none';
                            }
                            if (mi2) {
                                mi2.classList.add ("colItemCon");
                            }
                            if (mi4) {
                                mi4.classList.add ("colItemCon");
                            }
                        }
                    }
                    scannedMainEle.querySelectorAll(".textareaField").forEach(el => {
                    autoResize(el);
                    });
                    scannedMainEle.querySelectorAll(".callerLabel").forEach(el => {
                    updateCallerLabel(el);
                    });
                    scannedMainEle.querySelectorAll(".markdownField").forEach(el => {
                    updateMarkdownFields(el);
                    });
                    var allOptions = mi4.getElementsByClassName ("optionCon");
                    if (allOptions.length > 0) {
                        if (allOptions.length == 1) {
                            optionClicked (allOptions[0], false);
                        }
                        else {
                            for (var aos = 0; aos < allOptions.length; aos++) {
                                if (allOptions[aos].getAttribute ("data-chosen")) {
                                    optionClicked (allOptions[aos], false);
                                    break;
                                }
                            }
                        }
                    }
                    if (isActualClick != "yes") {
                        scannedMainEle.classList.add ("autoLoaded");
                    }
                    var theThumbID = scannedMainEle.id.replace ("main_", "thumb_");
                    var theThumbEle = document.getElementById (theThumbID);
                    var isGetFromCoordinates = false;
                    if (mi3) {
                        var coordinates = mi3.getAttribute ("data-coordinates");
                        if (coordinates) {
                            coordinates = coordinates.split ("|");
                            var pageNum = parseInt (coordinates[0], 10);
                            if (pageNum) {
                                var outputEle = document.getElementById ("output");
                                if (outputEle) {
                                    if (outputEle.children.length > 0) {
                                        var pagesImages = outputEle.children[0].getElementsByClassName ("pageImage");
                                        if (pagesImages.length >= pageNum) {
                                            if (pagesImages[pageNum - 1].src) {
                                                if (theThumbEle) {
                                                    //isGetFromCoordinates = true;
                                                    //theThumbEle.src = pagesImages[pageNum - 1].src;
                                                    //mi3.innerHTML += '<div class="w3-display-topleft coordinatesFrame"></div>';
                                                    //var coordinatesEle = mi3.children[mi3.children.length - 1];
                                                    //coordinatesEle.style.width = "50%";
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (!isGetFromCoordinates && theThumbEle) {
                        if (!theThumbEle.src) {
                            var theClassName = "";
                            if (theThumbEle.id.indexOf ("_slash_") != -1) {
                                theClassName = theThumbEle.id.slice (6).replace (/_slash_ID[A-Z0-9]+\s*/, "_slash_");
                            }
                            else {
                                theClassName = theThumbEle.id.slice (6).replace (/ID[A-Z0-9]+\s*/, ""); 
                            }
                            var counterpartEles = document.getElementsByClassName (theClassName);
                            for (var cpe = 0; cpe < counterpartEles.length; cpe++) {
                                if (counterpartEles[cpe].src) {
                                    theThumbEle.src = counterpartEles[cpe].src;
                                    break;
                                }
                            }
                        }
                    }
                    if (mi1) {
                        frameParent (mi1, 0);
                        if (mi4) {
                            var collapseEle = mi1.getElementsByClassName ("fa-caret-down");
                            if (collapseEle.length > 0) {
                                moveToTinyThumb (collapseEle[0]);
                                if (mi4.classList.contains ("oneOption")) {
                                    if (!scannedMainEle.classList.contains ("lonelyCon")) {
                                        collapse (collapseEle[0], null);
                                    }
                                }
                            }
                        }
                    }
                    if (scannedMainEle.classList.contains ("repeatedMain")) {
                        var scannedInputEle = document.getElementById (scannedMainEle.id.replace ("main_", "in_"));
                        var scannedFieldID = getFieldID (scannedInputEle.id);
                        if (scannedFieldID.search (/^ID0+$/) == 0) {
                            ID0SolveMainList.push (scannedMainEle);
                        }
                    }
                }
                //Hide the parent head if there is only one list
                if (!mainParentEle.classList.contains ("repeatedMain")) {
                    var lonelyListEle = optionPockectEle.getElementsByClassName ("lonelyListCon");
                    if (lonelyListEle.length == 1) {
                        var mi2ParentEle = document.getElementById (mainParentEle.id.replace ("main_", "mi2_"));
                        if (mi2ParentEle) {
                            var renamableEle = mi2ParentEle.getElementsByClassName ("renamable");
                            if (renamableEle.length == 0) {
                                var mi4ParentEle = document.getElementById (mainParentEle.id.replace ("main_", "mi4_"));
                                if (mi4ParentEle.classList.contains ("oneOption")) {
                                    mainParentEle.classList.add ("lonelyCon");
                                    var theFrameParentEle = mainParentEle.children[0];
                                    if (theFrameParentEle && theFrameParentEle.classList.contains ("w3-display-middle")) {
                                        theFrameParentEle.remove ();
                                    }
                                    var mi1ParentEle = document.getElementById (mainParentEle.id.replace ("main_", "mi1_"));
                                    if (mi1ParentEle) {
                                        var collapseParentEle = mi1ParentEle.getElementsByClassName ("awesomeArrow");
                                        if (collapseParentEle.length > 0) {
                                            collapse (collapseParentEle[0], false);
                                        }
                                        mi1ParentEle.classList.add ("lonelyHidden");
                                    }
                                    mi2ParentEle.classList.add ("lonelyHidden");
                                }
                            }
                        }
                    }
                }
                if (this.parentElement.parentElement.children.length < 3) {
                    switchDone (true);
                }
                this.parentElement.remove ();
            });

            var formEle = document.getElementById (formID);
            formEle.children[0].value = theMessage;
            formEle.children[1].value = document.getElementById(optionID).getAttribute ("data-paired");
            formEle.children[2].value = document.getElementById("op_trsd_main").getAttribute ("data-flags");
            formEle.children[3].value = location.href;
            if (optionID != "op_trsd_main") {
                var subFlags = document.getElementById(optionID).getAttribute ("data-flags");
                if (subFlags)
                    formEle.children[2].value += subFlags;
            }
            formEle.submit();
        }
        function makeRandom (length, characters) {
            var result = '';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++ ) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        function focusDone (theInputEle) {
            theInputEle.style.background = "rgba(66, 148, 136, 0.07)";
            if (theInputEle.tagName === "TEXTAREA") {
                theInputEle.style.height = "";
                theInputEle.style.height = (theInputEle.scrollHeight + 5) + "px";
            }
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                markOutputBlock (theInputEle);
            }
        }
        function blurDone (theInputEle) {
            theInputEle.style.background = "rgba(255, 255, 255, 1)";
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                unmarkOutputBlock (theInputEle);
            }
        }
        function unmarkOutputBlock (theInputEle) {
            var expectedParent = theInputEle.parentElement;
            var previewFrame = document.getElementById("previewFrame");
            if (previewFrame) {
                while (expectedParent) {
                    if (expectedParent.classList.contains("mainCon")) {
                        var theIdentifier = expectedParent.getAttribute("data-identifier");
                        if (theIdentifier) {
                            var matchingElement = previewFrame.contentWindow.document.querySelector(`[data-fi="${theIdentifier}"]`);
                            if (matchingElement) {
                                const tsFrame = matchingElement.firstElementChild;
                                if (tsFrame && tsFrame.classList.contains("ts-frame")) {
                                    tsFrame.style.border = "1px solid rgba(0, 100, 255, 0)";
                                }
                                break;
                            }
                        }
                    }
                    expectedParent = expectedParent.parentElement;
                }
            }
        }

        function autoResize (theInputEle) {
            if (theInputEle.tagName === "TEXTAREA") {
                theInputEle.style.height = "";
                theInputEle.style.height = (theInputEle.scrollHeight - 20) + "px";
            }
        }

        function updateCallerLabel (theInputEle) {
            var expectedParent = theInputEle.parentElement;
            while (expectedParent) {
                if (expectedParent.classList.contains("mainCon")) {
                    var mi2Ele = document.getElementById (expectedParent.id.replace ("main_", "mi2_"));
                    if (mi2Ele) {
                        var renamableEle = mi2Ele.getElementsByClassName ("renamable");
                        if (renamableEle.length == 1) {
                            renamableEle[0].value = theInputEle.value;
                            renamableEle[0].setAttribute ("data-labelfield", theInputEle.id);
                            break;
                        }
                    }
                }
                expectedParent = expectedParent.parentElement;
            }
        }

        function updateMarkdownFields (theInputEle) {
            new EasyMDE({ element: theInputEle,
            toolbar: [
                "bold",
                "italic",
                "link",
                "|",
                "heading",
                "unordered-list",
                "ordered-list",
                "|",
                {
                    name: "increaseIndent",
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const doc = cm.getDoc();
                        const selections = doc.listSelections();

                        cm.operation(() => {
                        selections.forEach(({ anchor, head }) => {
                            const from = Math.min(anchor.line, head.line);
                            const to = Math.max(anchor.line, head.line);

                            for (let i = from; i <= to; i++) {
                            doc.replaceRange("  ", { line: i, ch: 0 });
                            }
                        });
                        });
                    },
                    className: "fa fa-indent",
                    title: "Increase Indent"
                    },
                    {
                    name: "decreaseIndent",
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const doc = cm.getDoc();
                        const selections = doc.listSelections();

                        cm.operation(() => {
                        selections.forEach(({ anchor, head }) => {
                            const from = Math.min(anchor.line, head.line);
                            const to = Math.max(anchor.line, head.line);

                            for (let i = from; i <= to; i++) {
                            const line = doc.getLine(i);
                            if (line.startsWith("  ")) {
                                doc.replaceRange("", { line: i, ch: 0 }, { line: i, ch: 2 });
                            } else if (line.startsWith(" ")) {
                                doc.replaceRange("", { line: i, ch: 0 }, { line: i, ch: 1 });
                            }
                            }
                        });
                        });
                    },
                    className: "fa fa-outdent",
                    title: "Decrease Indent"
                    },
                "|",
                "preview",
                "guide"
            ]
            });
        }

        function inputChanging (theInputEle) {
            if (theInputEle.tagName === "TEXTAREA") {
                theInputEle.style.height = "";
                theInputEle.style.height = (theInputEle.scrollHeight + 5) + "px";
            }
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                if (theInputEle.type != "file" && theInputEle.value.indexOf ("op_") != 0) {
                    //changeOutputBlock (theInputEle);
                    if (theInputEle.classList.contains ("callerLabel")) {
                        updateCallerLabel (theInputEle);
                    }
                }
            }
        }
        function labelClicked (theEle) {
            //event.stopPropagation();
        }
        function renamableClicked (theEle) {
            event.stopPropagation();
        }
        function applyTransitionAndAddClass(element, className) {
            if (!element) return;
            element.style.transition = "all 0.5s ease";
            element.style.opacity = "0";
            element.style.transform = "translateY(-10px)";
            setTimeout(() => {
                element.classList.add(className);
                element.style.transition = "";
                element.style.opacity = "";
                element.style.transform = "";
            }, 400);
        }
        function topSelectedOptionClicked (theEle) {
            var mi2Ele = theEle.parentElement;
            if (mi2Ele) {
                var mi4Ele = document.getElementById (mi2Ele.id.replace ("mi2_", "mi4_"));
                if (mi4Ele) {
                    if (mi4Ele.classList.contains ("collapsedOptions")) {
                        mi4Ele.classList.remove ("collapsedOptions");
                        var mi3Ele = document.getElementById (mi2Ele.id.replace ("mi2_", "mi3_"));
                        if (mi3Ele) {
                            mi3Ele.classList.remove ("collapsedOptions");
                        }
                        var mi1Ele = document.getElementById (mi2Ele.id.replace ("mi2_", "mi1_"));
                        var collapseEle = mi1Ele.getElementsByClassName ("awesomeArrow");
                        if (collapseEle.length > 0) {
                            collapse (collapseEle[0], false);
                        }
                    } else {
                        applyTransitionAndAddClass (mi4Ele, "collapsedOptions");
                        var mi3Ele = document.getElementById (mi2Ele.id.replace ("mi2_", "mi3_"));
                        if (mi3Ele) {
                            applyTransitionAndAddClass (mi3Ele, "collapsedOptions");
                        }
                    }
                }
            }
            event.stopPropagation();
        }
        function renamableFocus (renamableEle) {
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                markOutputBlock (renamableEle);
            }
        }
        function renamableBlur (renamableEle) {
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                unmarkOutputBlock (renamableEle);
            }
        }
        function renamableChanging (renamableInputEle) {
            var labelFieldEle = document.getElementById (renamableInputEle.getAttribute ("data-labelfield"));
            if (labelFieldEle) {
                labelFieldEle.value = renamableInputEle.value;
            }
        }
        function showCropModal (theInputEle) {

            document.getElementById('crop-modal').style.display='block';
        }
        function inputChanged (theInputEle) {
            if (theInputEle.type == "file") {
                if (theInputEle.files.length > 1) {
                    for (var ief = theInputEle.files.length - 1; ief > 0; ief--) {
                        var newEle = newItemFromInput (theInputEle);
                        var newInputEle = document.getElementById (newEle.id.replace ("main_", "in_"));
                        if (newInputEle) {
                            const newDataTransfer = new DataTransfer();
                            newDataTransfer.items.add(theInputEle.files[ief]);
                            newInputEle.files = newDataTransfer.files;
                            inputChanged (newInputEle);
                        }
                    }
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(theInputEle.files[0]);
                    theInputEle.files = dataTransfer.files;
                }
                var file = theInputEle.files[0];
                //showCropModal (theInputEle);
                var fileConEle = theInputEle.parentElement.getElementsByClassName ("uploadFileCon");
                if (fileConEle.length > 0) {
                    if (theInputEle.getAttribute("data-changed") != "yes") {
                        fileConEle[0].previousSibling.children[0].innerHTML = "Reading...";
                    }
                }
                var reader  = new FileReader();
                reader.onload = function(e)  {
                    toUploadImage = document.createElement("img");
                    toUploadImage.src = e.target.result;
                    //cropperShowImage (toUploadImage.src);
                    var fileConEle = theInputEle.parentElement.getElementsByClassName ("uploadFileCon");
                    if (fileConEle.length > 0) {
                        if (fileConEle[0].hasChildNodes()) {
                            fileConEle[0].removeChild(fileConEle[0].children[0]);
                        }
                        fileConEle[0].classList.remove ("w3-display-middle");
                        fileConEle[0].classList.add ("w3-display-right");
                        if (toUploadImage.src.indexOf ("data:image") == 0) {
                            fileConEle[0].appendChild(toUploadImage);
                            fileConEle[0].previousSibling.children[0].style.width = "50%";
                        }
                        else {
                            fileConEle[0].previousSibling.children[0].style.width = "100%";
                        }
                        fileConEle[0].previousSibling.children[0].innerHTML = file.name;
                        var mi2 = document.getElementById (theInputEle.id.replace ("in_", "mi2_"));
                        if (mi2) {
                            var renamableInputEle = mi2.getElementsByClassName ("renamable");
                            if (renamableInputEle.length > 0) {
                                renamableInputEle[0].value = getPureDisplayName (file.name);
                            }
                        }
                    }
                }
                reader.readAsDataURL(file);
            }
            if (theInputEle.getAttribute("data-changed") != "yes") {
                theInputEle.setAttribute("data-changed", "yes");
            }
            var btnsLoaderEle = document.getElementById ("btnsLoader");
            if (btnsLoaderEle && btnsLoaderEle.style.display == "none") {
                markOutputBlock (theInputEle);
            }
        }
        function changeOutputBlock (theInputEle) {
            var expectedParent = theInputEle.parentElement;
            var previewFrame = document.getElementById("previewFrame");
            if (previewFrame) {
                while (expectedParent) {
                    if (expectedParent.classList.contains("mainCon")) {
                        var theIdentifier = expectedParent.getAttribute("data-identifier");
                        if (theIdentifier) {
                            const parentIdentifier = theIdentifier.slice (0, theIdentifier.lastIndexOf ("/"));;
                            const filePureName = theIdentifier.slice (theIdentifier.lastIndexOf ("/") + 1);
                            var matchingElement = previewFrame.contentWindow.document.querySelector(`[data-fi="${parentIdentifier}"]`);
                            if (matchingElement) {
                                var fileElement = matchingElement.querySelector(`[data-fn="${filePureName}"]`);
                                if (fileElement) {
                                    const inputValue = theInputEle.value;
                                    const paragraphs = inputValue.split(/\r?\n|\r/);
                                    const paragraphsWithPTags = paragraphs.map(paragraph => `<p>${paragraph.trim()}</p>`);
                                    fileElement.innerHTML = paragraphsWithPTags.join('\n');;
                                }
                            }
                            break;
                        }
                    }
                    expectedParent = expectedParent.parentElement;
                }
            }
        } 
        function markOutputBlock(theInputEle) {
            var expectedParent = theInputEle.parentElement;
            var previewFrame = document.getElementById("previewFrame");
            if (previewFrame) {
                while (expectedParent) {
                    if (expectedParent.classList.contains("mainCon")) {
                        var theIdentifier = expectedParent.getAttribute("data-identifier");
                        if (theIdentifier) {
                            var matchingElement = previewFrame.contentWindow.document.querySelector(`[data-fi="${theIdentifier}"]`);
                            if (matchingElement) {
                                const tsFrame = matchingElement.firstElementChild;
                                if (tsFrame && tsFrame.classList.contains("ts-frame")) {
                                    tsFrame.style.border = "2px solid rgba(0, 100, 255, 1)";
                                    tsFrame.scrollIntoView({
                                        behavior: "smooth",
                                        block: "center",
                                        inline: "center"
                                    });
                                }
                                break;
                            }
                        }
                    }
                    expectedParent = expectedParent.parentElement;
                }
            }
        }
        function changeFieldID (checkEle, oldFieldID, newFieldID) {
            for (var attr of checkEle.attributes) {
                if (attr.value.indexOf ("_" + oldFieldID) != -1) {
                    var valueSplitted = attr.value.split ("_trsd_option_sep_");
                    valueSplitted[0] = valueSplitted[0].replace (new RegExp ("_" + oldFieldID, 'g'), "_" + newFieldID);
                    attr.value = valueSplitted.join ("_trsd_option_sep_");
                }
            }

            for (var i = 0; i < checkEle.children.length; i++) {
                changeFieldID (checkEle.children[i], oldFieldID, newFieldID);
            }
        }
        function getFieldID (inputEleID) {
            var fieldID = null;
            fieldID = inputEleID.match (/(in_ID[A-Z0-9]+)|(:ID[A-Z0-9]+)|(_slash_ID[A-Z0-9]+)/g);
            if (fieldID) {
                fieldID = fieldID[fieldID.length - 1];
                fieldID = fieldID.match (/ID[A-Z0-9]+/)[0];
            }
            return fieldID;
        }
        function newItemFromInput (theInputEle) {
            var mainEle = document.getElementById (theInputEle.id.replace ("in_", "main_"));
            var newNode = mainEle.cloneNode (true);
            var oldFieldID = getFieldID (theInputEle.id);
            if (!oldFieldID) {
                return null;
            }
            var newFieldID = produceNewID (theInputEle.id, oldFieldID, 0, false);
            mainEle.parentElement.insertBefore (newNode, mainEle.nextSibling);
            var newMainEle = mainEle.nextSibling;
            changeFieldID (newMainEle, oldFieldID, newFieldID);
            rearrange (mainEle);
            return newMainEle;
        }
        function produceNewID (oldElementID, oldFieldID, tryingCounter, isToAddZero) {
            tryingCounter++;
            var testedID = oldFieldID;
            var returnedID = "ID1";
            if (oldFieldID.indexOf ("ID") == 0) {
                testedID = oldFieldID.slice (2);
            }
            if (testedID != "") {
                if (isToAddZero) {
                    returnedID = "ID0" + testedID;
                    isToAddZero = false;
                }
                else {
                    if (testedID.length > 4) {
                        returnedID = "ID" + makeRandom (testedID.length, "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ");
                    } else {
                        if (testedID.search (/^[0-9]+$/) == 0) {
                            returnedID = "ID" + addOneToCustomSystem (testedID, "0123456789");
                        }
                        else {
                            returnedID = "ID" + addOneToCustomSystem (testedID, "ABCDEFGHIJKLMNOPQRSTUVWXYZ");
                        }
                    }
                }
                var valueSplitted = oldElementID.split ("_trsd_option_sep_");
                valueSplitted[0] = valueSplitted[0].replace (new RegExp ("_" + oldFieldID, 'g'), "_" + returnedID);
                var newElementID = valueSplitted.join ("_trsd_option_sep_");
                var testNewIDEle = document.getElementById (newElementID);
                if (testNewIDEle || returnedID.search (/^ID0+$/) == 0) {
                    if (tryingCounter > 100) {
                        tryingCounter = 0;
                        isToAddZero = true;
                    }
                    return produceNewID (newElementID, returnedID, tryingCounter, isToAddZero);
                }
            }
            return returnedID;
        }
        function addOneToCustomSystem(number, systemDigits) {
            const base = systemDigits.length;
            const digitToIndex = {};
            
            // Create a mapping from digits to their indices
            for (let i = 0; i < systemDigits.length; i++) {
                digitToIndex[systemDigits[i]] = i;
            }
            
            // Convert number to base 10
            let base10Number = 0;
            for (let char of number) {
                base10Number = base10Number * base + digitToIndex[char];
            }
            
            // Add 1 to the base 10 number
            base10Number += 1;
            
            // Convert the new base 10 number back to the custom base
            let newNumber = '';
            while (base10Number > 0) {
                newNumber = systemDigits[base10Number % base] + newNumber;
                base10Number = Math.floor(base10Number / base);
            }
            
            // Pad the result to ensure it keeps the original length or increases
            while (newNumber.length < number.length) {
                newNumber = systemDigits[0] + newNumber;
            }
            
            return newNumber;
        }
        function cloneItemFromInput (theInputEle) {
            var mainEle = document.getElementById (theInputEle.id.replace ("in_", "main_"));
            var newNode = mainEle.cloneNode (true);
            var toRepeat = newNode.outerHTML;
            var oldName = theInputEle.id.replace ("in_", "");
            if (oldName.indexOf ("_slash_") != -1) {
                oldName = oldName.slice (oldName.lastIndexOf ("_slash_") + 7);
            }
            var oldInputName = theInputEle.name.replace ("in_", "");
            if (oldInputName.indexOf ("_slash_") != -1) {
                oldInputName = oldInputName.slice (oldInputName.lastIndexOf ("_slash_") + 7);
            }
            var oldFieldID = getFieldID (theInputEle.id);
            if (!oldFieldID) {
                return null;
            }
            var newFieldID = produceNewID (theInputEle.id, oldFieldID, 0, false);
            var newName = oldName.replace (oldFieldID, newFieldID).replace(/\s?ts_ro(_\w+)+|\s?ts_ro(?!\w)|\s?ts_ro$/, "");
            var re = new RegExp("(?<!_trsd_option_sep_)" + oldName.replace (/([\{\}\[\]\(\)\^\$\.\|\?\*\+])/g, '\\$1'), "g");
            toRepeat = toRepeat.replace (re, newName);
            var newInputName = oldInputName.replace (oldFieldID, newFieldID).replace(/\s?ts_ro(_\w+)+|\s?ts_ro(?!\w)|\s?ts_ro$/, "");
            var reInput = new RegExp("(?<!_trsd_option_sep_)" + oldInputName.replace (/([\{\}\[\]\(\)\^\$\.\|\?\*\+])/g, '\\$1'), "g");
            toRepeat = toRepeat.replace (reInput, newInputName);
            toRepeat = toRepeat.replace (/\s?data-changed=\"yes\"/, "");
            toRepeat = toRepeat.replace (/\s?selectedOptionCon/, "");
            mainEle.parentElement.insertBefore (newNode, mainEle.nextSibling);
            var newMainEle = mainEle.nextSibling;
            newMainEle.outerHTML = toRepeat;
            var newInputID = theInputEle.id.replace (re, newName);
            var newInputEle = document.getElementById (newInputID);
            if (newInputEle) {
                newMainEle = document.getElementById (newInputEle.id.replace ("in_", "main_"));
                var isZeroOption = false;
                var isSubKeyFirst = false;
                if (newMainEle) {
                    newMainEle.classList.remove ("autoLoaded");
                    var mi1 = document.getElementById (newMainEle.id.replace ("main_", "mi1_"));
                    var collapseEle = mi1.getElementsByClassName ("awesomeArrow");
                    if (collapseEle.length > 0) {
                        collapseEle[0].classList.remove ("noCollapse");
                        collapse (collapseEle[0], false);
                    }
                    var mi2 = document.getElementById (newMainEle.id.replace ("main_", "mi2_"));
                    if (mi2) {
                        var subkeyLinkEles = mi2.getElementsByTagName ("a");
                        for (var sles = subkeyLinkEles.length - 1; sles >= 0; sles--) {
                            var linkEle = subkeyLinkEles[sles];
                            if (linkEle.classList.contains ("subKey")) {
                                isSubKeyFirst = true;
                            }
                            var linkEleParent = linkEle.parentNode;
                            while (linkEle.firstChild) linkEleParent.insertBefore(linkEle.firstChild, linkEle);
                            linkEleParent.removeChild (linkEle);
                        }
                    }
                    var mi4 = document.getElementById (newMainEle.id.replace ("main_", "mi4_"));
                    var downloadDivEle = mi4.getElementsByClassName ("downloadDiv");
                    if (downloadDivEle.length > 0) {
                        downloadDivEle[0].remove ();
                    }
                    var theThumbID = newMainEle.id.replace ("main_", "thumb_");
                    var theThumbEle = document.getElementById (theThumbID);
                    if (theThumbEle) {
                        theThumbEle.removeAttribute ("src");
                    }
                    rearrange (mainEle);
                    var mi4 = document.getElementById (newMainEle.id.replace ("main_", "mi4_"));
                    var allOptCon = mi4.getElementsByClassName("optionCon");
                    for (var ao = 0; ao < allOptCon.length; ao++) {
                        if (!mi4.classList.contains ("oneOption") && !allOptCon[ao].getAttribute ("data-subkey") && allOptCon[ao].classList.contains ("fakeOption")) {
                            var optionPockectEle = document.getElementById (allOptCon[ao].id.replace ("op_", "pocket_"));
                            if (optionPockectEle) {
                                optionPockectEle.remove ();
                            }
                            allOptCon[ao].remove ();
                        }
                        else {
                            allOptCon[ao].classList.remove ("selectedOptionfake");
                            allOptCon[ao].removeAttribute ("data-called");
                            allOptCon[ao].removeAttribute ("data-subkey");
                            if (allOptCon[ao].getAttribute ("data-paired").indexOf ('trsd_paired_default_') == 0) {
                                allOptCon[ao].setAttribute ("data-paired", "");
                            }
                        }
                    }
                    if (isSubKeyFirst) {
                        var testedName = mainEle.id;
                        if (testedName.indexOf ("_slash_") != -1) {
                            testedName = testedName.slice (testedName.lastIndexOf ("_slash_") + 7);
                        }
                        if (testedName.search (/ID0+[^A-Z1-9]/) == 0) {
                            if (mainEle.classList.contains ("subKeyMain")) {

                            }
                            else {
                                isZeroOption = true;
                                mainEle.remove ();
                                if (mi4.classList.contains ("oneOption")) {
                                    triggerOneOption (newMainEle);
                                }
                            }
                        }
                    }
                }
                if (newInputEle.value.indexOf ("op_") == 0) {
                    if (!isZeroOption && !isSubKeyFirst) {
                        newInputEle.value = "op_empty";
                    }
                }
                else {
                    newInputEle.value = "";
                    if (newInputEle.type == "file") {
                        var fileConEle = newInputEle.parentElement.getElementsByClassName ("uploadFileCon");
                        if (fileConEle.length > 0) {
                            fileConEle[0].previousSibling.children[0].innerHTML = "";
                        }
                    }
                }
                return newMainEle;
            }
            return null;
        }
        function tsFillZeros (number, digitsCount) {
            var digits = number.toString();
            while (digits.length < digitsCount)
                digits = "0" + digits;
            return digits;
        }
        function countList (theEle) {
            if (theEle.classList.contains ("repeatedMain")) {
                var allBrothers = theEle.parentElement.children;
                var theCount = 0;
                for (var ab = 0; ab < allBrothers.length; ab++) {
                    if (!allBrothers[ab].classList.contains ("mainCon") || allBrothers[ab].classList.contains ("removedByUser")) {
                        continue;
                    }
                    theCount++;
                }
            }
            return theCount;
        }
        function rearrange (theEle) {
            if (theEle.classList.contains ("repeatedMain")) {
                var allBrothers = theEle.parentElement.children;
                var theOrder = 0;
                for (var ab = 0; ab < allBrothers.length; ab++) {
                    if (!allBrothers[ab].classList.contains ("mainCon") || allBrothers[ab].classList.contains ("removedByUser")) {
                        continue;
                    }
                    var thePrefix = tsFillZeros (theOrder++ + 1, 2) + ".&nbsp;";
                    var thePrefixEle = document.getElementById (allBrothers[ab].id.replace ("main_", "prefix_"));
                    var level = allBrothers[ab].getAttribute ("data-level");
                    if (!level) {
                        level = 0;
                    }
                    else {
                        level--;
                    }
                    frameParent (thePrefixEle, level);
                    thePrefixEle.innerHTML = thePrefix;
                }
            }
            var callerOptionEle = document.getElementById (getCallerOptionID (theEle));
            callerOptionEle.setAttribute ('data-sort', 'yes');
        }
        function optionClicked (theOpt, isAtualClick) {
            var theDefault = null;
            if (theOpt.classList.contains("selectedOptionCon")) {
                if (theOpt.classList.contains("isDefault")) {
                    var allBrothers = theOpt.parentElement.children;
                    for (var ab = 0; ab < allBrothers.length; ab++) {
                        if (allBrothers[ab].classList.contains("fakeOption")) {
                            theDefault = theOpt;
                            theOpt = allBrothers[ab];
                            break;
                        }
                    }
                }
            }
            else {
                if (theOpt.classList.contains("fakeOption")) {
                    var allBrothers = theOpt.parentElement.children;
                    for (var ab = 0; ab < allBrothers.length; ab++) {
                        if (allBrothers[ab].classList.contains("isDefault")) {
                            theDefault = allBrothers[ab];
                            break;
                        }
                    }
                }
            }
            if (!theOpt.classList.contains("selectedOptionCon")) {
                var allBrothers = theOpt.parentElement.children;
                var rnmEle = null;
                var newOptionName = null;
                var restOptionsNames = [];
                for (var ab = 0; ab < allBrothers.length; ab++) {
                    if (allBrothers[ab].id == theOpt.id) {
                        var mainEle = theOpt.parentElement.parentElement.parentElement;
                        var mi1Ele = document.getElementById (mainEle.id.replace ("main_", "mi1_"));
                        var mi2Ele = document.getElementById (mainEle.id.replace ("main_", "mi2_"));
                        var mi4Ele = document.getElementById (mainEle.id.replace ("main_", "mi4_"));
                        if (mi2Ele) {
                            if (!mi4Ele || !mi4Ele.classList.contains ("oneOption") || !allBrothers[ab].classList.contains("fakeOption")) {
                                var topSelectedOptionEle = mi2Ele.getElementsByClassName ("topSelectedOption");
                                if (topSelectedOptionEle.length > 0) {
                                    topSelectedOptionEle[0].classList.remove ("topHidden");
                                    var topOptionImgEle = topSelectedOptionEle[0].getElementsByClassName ("optionImg");
                                    if (allBrothers[ab].classList.contains("fakeOption")) {
                                        if (theDefault) {
                                            topSelectedOptionEle[0].innerHTML = theDefault.innerHTML;
                                        }
                                        if (topOptionImgEle.length > 0) {
                                            topOptionImgEle[0].style.border = "3px solid orange";
                                        }
                                    }
                                    else {
                                        topSelectedOptionEle[0].innerHTML = allBrothers[ab].innerHTML;
                                        if (topOptionImgEle.length > 0) {
                                            topOptionImgEle[0].style.border = "3px solid lightseagreen";
                                        }
                                    }
                                    var verticalTextEle = topSelectedOptionEle[0].getElementsByClassName ("verticalText");
                                    if (verticalTextEle.length > 0) {
                                        verticalTextEle[0].classList.remove ("verticalText");
                                    }
                                    if (topSelectedOptionEle[0].firstElementChild) {
                                        const firstChild = topSelectedOptionEle[0].firstElementChild;
                                        topSelectedOptionEle[0].appendChild(firstChild);
                                    }
                                    if (mi1Ele) {
                                        theTriangleEle = mi1Ele.getElementsByClassName ("awesomeArrow");
                                        if (theTriangleEle.length > 0) {
                                            if (theOpt.getAttribute("data-paired") == "no_paired") {
                                                theTriangleEle[0].style.display = 'none';
                                            }
                                            else {
                                                theTriangleEle[0].style.display = 'block';
                                            }
                                        }
                                    }
                                    if (mi4Ele) {
                                        if (isAtualClick) {
                                            applyTransitionAndAddClass (mi4Ele, "collapsedOptions");
                                        }
                                        else {
                                            mi4Ele.classList.add ("collapsedOptions");
                                        }
                                        var mi3Ele = document.getElementById (mi2Ele.id.replace ("mi2_", "mi3_"));
                                        if (mi3Ele) {
                                            if (isAtualClick) {
                                                applyTransitionAndAddClass (mi3Ele, "collapsedOptions");
                                            }
                                            else {
                                                mi3Ele.classList.add ("collapsedOptions");
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        if (theDefault) {
                            theDefault.classList.add("selectedOptionfake");
                        }
                        allBrothers[ab].classList.add("selectedOptionCon");
                        allBrothers[ab].classList.remove("selectedOptionfake");
                        rnmEle = document.getElementById (mainEle.id.replace ("main_", "rnm_in_"));
                        var optionText = theOpt.getElementsByClassName ("optionText");
                        if (optionText.length > 0) {
                            newOptionName = optionText[0].innerHTML;
                        }
                        var isTxt = (theOpt.id.slice (-8).toLowerCase() == "_dot_txt");
                        var optionConEle = null;
                        if (isTxt) {
                            var theTested = theOpt.getElementsByClassName ("optionContent");
                            if (theTested.length > 0) {
                                optionConEle = theTested[0]; 
                            }
                        }
                        var hiddenInputID = mainEle.id.replace ("main_", "in_");
                        var hiddenInput = document.getElementById (hiddenInputID);
                        hiddenInput.value = theOpt.id;
                        inputChanged (hiddenInput);
                        if (theOpt.getAttribute("data-paired") != "no_paired") {
                            if (theOpt.getAttribute("data-called") == 'yes') {
                                setFollowing (theOpt, true, "toDeleteBeforeSubmit", true);
                            }
                            if (theOpt.getAttribute("data-subkey") != 'yes' || isAtualClick) {
                                theOpt.setAttribute("data-called", 'yes');
                                goOptionsSubmit (theOpt.id, isAtualClick);
                            }
                            else if (!isAtualClick && theOpt.getAttribute("data-subkey") == 'yes') {
                                theOpt.classList.remove("selectedOptionCon");
                                if (mi1Ele) {
                                    theTriangleEle = mi1Ele.getElementsByClassName ("awesomeArrow");
                                    if (theTriangleEle.length > 0) {
                                        theTriangleEle[0].setAttribute ("data-optionid", theOpt.id);
                                        moveToTinyThumb (theTriangleEle[0]);
                                        var thePlusEle = mi1Ele.getElementsByClassName ("fa-plus-circle");
                                        if (thePlusEle.length > 0) {
                                            thePlusEle[0].classList.add ("notLoadedYet");
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else {
                        allBrothers[ab].classList.remove("selectedOptionCon");
                        if (theDefault == null) {
                            allBrothers[ab].classList.remove("selectedOptionfake");
                        }
                        setFollowing (allBrothers[ab], false, "toDeleteBeforeSubmit", false);
                        var optionText = allBrothers[ab].getElementsByClassName ("optionText");
                        if (optionText.length > 0) {
                            restOptionsNames.push (optionText[0].innerHTML);
                        }
                    }
                }
                if (rnmEle && newOptionName) {
                    var isToChangeName = false;
                    for (var ron = 0; ron < restOptionsNames.length; ron++) {
                        if (restOptionsNames[ron] == rnmEle.value) {
                            isToChangeName = true;
                            break;
                        }
                    }
                    if (isToChangeName) {
                        rnmEle.value = newOptionName;
                    }
                }  
            }
        }
        function setFollowing (theOpt, isToRemove, theClass, isForSelected) {
            var optionPockectEle = document.getElementById (theOpt.id.replace ("op_", "pocket_"));
            var subItems = null;
            if (isForSelected) {
                subItems = [];
                var pocketChilds = optionPockectEle.children;
                for (var pcs = 0; pcs < pocketChilds.length; pcs++) {
                    if (pocketChilds[pcs].classList.contains ("listCon")) {
                        if (pocketChilds[pcs].children.length > 0) {
                            subItems = subItems.concat (pocketChilds[pcs].children);
                        }
                    }
                    else if (pocketChilds[pcs].classList.contains ("mainCon")) {
                        subItems.push (pocketChilds[pcs]);
                    }
                }
            }
            else {
                subItems = optionPockectEle.getElementsByClassName ("mainCon");
            }
            for (var sis = 0; sis < subItems.length; sis++) {
                if (!subItems[sis].classList) {
                    continue;
                }
                if (isToRemove) {
                    subItems[sis].classList.remove (theClass);
                }
                else {
                    subItems[sis].classList.add (theClass);
                }
                if (isForSelected) {
                    var mi4Ele = document.getElementById (subItems[sis].id.replace ("main_", "mi4_"));
                    if (mi4Ele) {
                        var optionsConEle = mi4Ele.getElementsByClassName ("optionsCon");
                        if (optionsConEle.length > 0) {
                            var allOptions = optionsConEle[0].children;
                            if (allOptions.length > 0) {
                                for (var aos = 0; aos < allOptions.length; aos++) {
                                    if (allOptions[aos].classList.contains("selectedOptionCon")) {
                                        setFollowing (allOptions[aos], isToRemove, theClass, isForSelected);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }


        /*
        * cropper.js -- v0.1
        * Copyright 2012 Oscar Key
        * A simple cropperImage cropperCropping library which uses pure Javascript and the <cropperCanvas> tag in order to crop images in the browser.
        */

        /*
        * This program is free software: you can redistribute it and/or modify
        * it under the terms of the GNU General Public License as published by
        * the Free Software Foundation, either version 3 of the License, or
        * (at your option) any later version.
        *
        * This program is distributed in the hope that it will be useful,
        * but WITHOUT ANY WARRANTY; without even the implied warranty of
        * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        * GNU General Public License for more details.
        *
        * You should have received a copy of the GNU General Public License
        * along with this program.  If not, see <http://www.gnu.org/licenses/>.
        */

        var cropperCanvas;
        var cropperContext;

        var cropperImage;
        var cropperRestoreImage;
        var cropperCurrentDimens = {};
        var cropperCropping = false;

        var cropperColors = {
            white: "#ffffff",
            black: "#000000",
            overlay: "rgba(0, 0, 0, 0.6)"
        };

        var overlay;

        function draw() {
            // clear the cropperCanvas
            cropperContext.clearRect(0, 0, cropperCanvas.width, cropperCanvas.height);

            // if we don't have an cropperImage file, abort the draw at this point
            if(cropperImage === undefined) {
                return;
            }

            // draw the cropperImage
            var dimens = cropperCurrentDimens;
            cropperContext.drawImage(cropperImage, 0, 0, dimens.width, dimens.height);

            // draw cropperCropping stuff if we are cropperCropping
            if(cropperCropping) {
                // draw the overlay
                drawOverlay();

                // draw the resizer
                var x = overlay.x + overlay.width - 5,
                    y = overlay.y + overlay.height - 5,
                    w = overlay.resizerSide,
                    h = overlay.resizerSide;

                cropperContext.save();
                cropperContext.fillStyle = cropperColors.black;
                cropperContext.strokeStyle = cropperColors.white;
                cropperContext.fillRect(x, y, w, h);
                cropperContext.strokeRect(x, y, w, h);
                cropperContext.restore();
            }
        }

        function drawOverlay() {
            // draw the overlay using a path made of 4 trapeziums (ahem)
            cropperContext.save();

            cropperContext.fillStyle = cropperColors.overlay;
            cropperContext.beginPath();

            cropperContext.moveTo(0, 0);
            cropperContext.lineTo(overlay.x, overlay.y);
            cropperContext.lineTo(overlay.x + overlay.width, overlay.y);
            cropperContext.lineTo(cropperCanvas.width, 0);

            cropperContext.moveTo(cropperCanvas.width, 0);
            cropperContext.lineTo(overlay.x + overlay.width, overlay.y);
            cropperContext.lineTo(overlay.x + overlay.width, overlay.y + overlay.height);
            cropperContext.lineTo(cropperCanvas.width, cropperCanvas.height);

            cropperContext.moveTo(cropperCanvas.width, cropperCanvas.height);
            cropperContext.lineTo(overlay.x + overlay.width, overlay.y + overlay.height);
            cropperContext.lineTo(overlay.x, overlay.y + overlay.height);
            cropperContext.lineTo(0, cropperCanvas.height);

            cropperContext.moveTo(0, cropperCanvas.height);
            cropperContext.lineTo(overlay.x, overlay.y + overlay.height);
            cropperContext.lineTo(overlay.x, overlay.y);
            cropperContext.lineTo(0, 0);

            cropperContext.fill();

            cropperContext.restore();
        }

        function setRatio(ratio) {
            overlay.ratioXY = ratio;
            overlay.height = Math.floor(overlay.width * ratio);
        }

        function getScaledImageDimensions(width, height) {
            // choose the dimension to scale to, depending on which is "more too big"
            var factor = 1;
            if((cropperCanvas.width - width) < (cropperCanvas.height - height)) {
                // scale to width
                factor = cropperCanvas.width / width;
            } else {
                // scale to height
                factor = cropperCanvas.height / height;
            }
            // important "if,else" not "if,if" otherwise 1:1 images don't scale

            var dimens = {
                width: Math.floor(width * factor),
                height: Math.floor(height * factor),
                factor: factor
            };

            return dimens;
        }

        function getTouchPos(touchEvent) {
            var rect = cropperCanvas.getBoundingClientRect();

            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }
        /**
         * @param {Number} x position mouse / touch client event
         * @param {Number} y position mouse / touch client event
         */
        function getClickPos({x, y}) {
            return {
                x : x - window.scrollX,
                y : y - window.scrollY
            }	
        }

        function isInOverlay(x, y) {
            return x > overlay.x && x < (overlay.x + overlay.width) && y > overlay.y && y < (overlay.y + overlay.height);
        }

        function isInHandle(x, y) {
            return x > (overlay.x + overlay.width - overlay.resizerSide) && x < (overlay.x + overlay.width + overlay.resizerSide) && y > (overlay.y + overlay.height - overlay.resizerSide) && y < (overlay.y + overlay.height + overlay.resizerSide);
        }

        /* EVENT LISTENER STUFF */
        var drag = {
            type: "", // options: "moveOverlay", "resizeOverlay"
            inProgress: false,
            originalOverlayX: 0,
            originalOverlayY: 0,
            originalX: 0,
            originalY: 0,
            originalOverlayWidth: 0,
            originalOverlayHeight: 0
        };

        /**
         * @param {Number} x position mouse / touch client event
         * @param {Number} y position mouse / touch client event
         */
        function initialCropOrMoveEvent({x, y}) {
            // if the mouse clicked in the overlay	
            if(isInOverlay(x, y)) {
                drag.type = "moveOverlay";
                drag.inProgress = true;
                drag.originalOverlayX = x - overlay.x;
                drag.originalOverlayY = y - overlay.y;
            }
            
            if(isInHandle(x, y)) {
                drag.type = "resizeOverlay";
                drag.inProgress = true;
                drag.originalX = x;
                drag.originalY = y;
                drag.originalOverlayWidth = overlay.width;
                drag.originalOverlayHeight = overlay.height;
            }
        }

        /**
         * @param {Number} x horizontal position mouse or touch event
         * @param {Number} y vertical position mour or touch event
         * @description this function will be crop cropperImage inside cropperCanvas
         */
        function startCropOrMoveEvent({x, y}) {

            // Set current cursor as appropriate
            if(isInHandle(x, y) || (drag.inProgress && drag.type === "resizeOverlay")) {
                cropperCanvas.style.cursor = 'nwse-resize'
            } else if(isInOverlay(x, y)) {
                cropperCanvas.style.cursor = 'move'
            } else {
                cropperCanvas.style.cursor = 'auto'
            }

            // give up if there is no drag in progress
            if(!drag.inProgress) {
                return;
            }

            // check what type of drag to do
            if(drag.type === "moveOverlay") {
                overlay.x = x - drag.originalOverlayX;
                overlay.y = y - drag.originalOverlayY;

                // Limit to size of cropperCanvas.
                var xMax = cropperCanvas.width - overlay.width;
                var yMax = cropperCanvas.height - overlay.height;

                if(overlay.x < 0) {
                    overlay.x = 0;
                } else if(overlay.x > xMax) {
                    overlay.x = xMax;
                }

                if(overlay.y < 0) {
                    overlay.y = 0;
                } else if(overlay.y > yMax) {
                    overlay.y = yMax;
                }

                draw();
            } else if(drag.type === "resizeOverlay") {
                overlay.width = drag.originalOverlayWidth + (x - drag.originalX);

                // do not allow the overlay to get too small
                if(overlay.width < 10) {
                    overlay.width = 10;
                }

                // Don't allow crop to overflow
                if(overlay.x + overlay.width > cropperCanvas.width) {
                    overlay.width = cropperCanvas.width - overlay.x;
                }

                overlay.height = overlay.width * overlay.ratioXY;

                if(overlay.y + overlay.height > cropperCanvas.height) {
                    overlay.height = cropperCanvas.height - overlay.y;
                    overlay.width = overlay.height / overlay.ratioXY;
                }

                draw();
            }
        }	

        function addEventListeners() {
            // add mouse listeners to the cropperCanvas
            cropperCanvas.onmousedown = function(event) {
                // depending on where the mouse has clicked, choose which type of event to fire
                var coords = cropperCanvas.getMouseCoords (event);
                initialCropOrMoveEvent(getClickPos(coords));
            };

            cropperCanvas.onmouseup = function(event) {
                // cancel any drags
                drag.inProgress = false;
            };

            cropperCanvas.onmouseout = function(event) {
                // cancel any drags
                drag.inProgress = false;
            };

            cropperCanvas.onmousemove = function(event) {
                var coords = cropperCanvas.getMouseCoords (event);

                startCropOrMoveEvent(getClickPos(coords));
            };

            cropperCanvas.addEventListener('touchstart', event => {
                initialCropOrMoveEvent(getTouchPos(event));
            });

            cropperCanvas.addEventListener('touchmove', event => {
                startCropOrMoveEvent(getTouchPos(event));
            });

            cropperCanvas.addEventListener('touchend', event => {
                drag.inProgress = false;
            })
        }


        /* CROPPING FUNCTIONS */
        function cropImage (entire) {
            // if we don't have an cropperImage file, abort at this point
            if(cropperImage === undefined) {
                return false;
            }

            // if we aren't cropperCropping, ensure entire is tru
            if(!cropperCropping) {
                entire = true;
            }

            // assume we want to crop the entire cropperImage, this will be overriden below
            var x = 0;
            var y = 0;
            var width = cropperImage.width;
            var height = cropperImage.height;

            if(!entire) {
                // work out the actual dimensions that need cropperCropping
                var factor = cropperCurrentDimens.factor;
                x = Math.floor(overlay.x / factor);
                y = Math.floor(overlay.y / factor);
                width = Math.floor(overlay.width / factor);
                height = Math.floor(overlay.height / factor);

                // check the values are within range of the cropperImage
                if(x < 0){ x = 0; }
                if(x > cropperImage.width){ x = cropperImage.width; }
                if(y < 0){ y = 0; }
                if(y > cropperImage.height){ y = cropperImage.height; }

                if(x + width > cropperImage.width){ width = cropperImage.width - x; }
                if(y + height > cropperImage.height){ height = cropperImage.height - y; }
            }

            // load the cropperImage into the cropperCropping cropperCanvas
            var cropCanvas = document.createElement("canvas");
            cropCanvas.setAttribute("width", width);
            cropCanvas.setAttribute("height", height);

            var cropContext = cropCanvas.getContext("2d");
            cropContext.drawImage(cropperImage, x, y, width, height, 0, 0, width, height);

            return cropCanvas;
        }

        /* function borrowed from http://stackoverflow.com/a/7261048/425197 */
        function dataUrlToBlob(dataURI) {
            // convert base64 to raw binary data held in a string
            var byteString = atob(dataURI.split(',')[1]);

            // separate out the mime component
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

            // write the bytes of the string to an ArrayBuffer
            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            // write the ArrayBuffer to a blob, and you're done
            return new Blob([ia], {type: mimeString});
        }

        function cropperShowImage (src) {
            cropperCropping = false;
            cropperImage = new Image();
            cropperImage.onload = function() {
                cropperCurrentDimens = getScaledImageDimensions(cropperImage.width, cropperImage.height) ; // work out the scaling
                draw();
            };
            cropperImage.src = src;
        }

        function cropperStartCropping () {
            // only continue if an cropperImage is loaded
            if(cropperImage === undefined) {
                return false;
            }

            // save the current state
            cropperRestoreImage = new Image();
            cropperRestoreImage.src = cropperImage.src;

            cropperCropping = true;
            draw();

            return true;
        }

        function cropperGetCroppedImageSrc () {
            if(cropperImage) {
                // return the cropped cropperImage
                var cropCanvas = cropImage (!cropperCropping); // cropperCropping here controls if we get the entire cropperImage or not, desirable if the user is not cropperCropping
                var url = cropCanvas.toDataURL("png");

                // show the new cropperImage, only bother doing this if it isn't already displayed, ie, we are cropperCropping
                if(cropperCropping) {
                    cropperShowImage(url);
                }

                cropperCropping = false;
                return url;
            } else {
                return false;
            }
        }

        function cropperGetCroppedImageBlob (type) {
            if(cropperImage) {
                // return the cropped cropperImage
                var cropCanvas = cropImage(!cropperCropping); // cropperCropping here controls if we get the entire cropperImage or not, desirable if the user is not cropperCropping
                var url = cropCanvas.toDataURL(type || "png");

                // show the new cropperImage, only bother doing this if it isn't already displayed, ie, we are cropperCropping
                if(cropperCropping) {
                    cropperShowImage(url);
                }

                cropperCropping = false;

                // convert the url to a blob and return it
                return dataUrlToBlob(url);
            } else {
                return false;
            }
        }
        cropperStart (document.getElementById("crop-canvas"), 1);
        function cropperStart (newCanvas, ratio) {
            // get the cropperContext from the given cropperCanvas
            cropperCanvas = newCanvas;
            if(!cropperCanvas.getContext) {
                return; // give up
            }
            cropperContext = cropperCanvas.getContext("2d");

            // Set default overlay position
            overlay = {
                x: 50,
                y: 50,
                width: 100,
                height: 100,
                resizerSide: 10,
                ratioXY: 1
            }

            // set up the overlay ratio
            if(ratio) {
                setRatio(ratio);
            }

            // setup mouse stuff
            addEventListeners();
        }

        function cropperRestore () {
            if(cropperRestoreImage === undefined) {
                return false;
            }

            cropperCropping = false;

            // show the saved cropperImage
            cropperShowImage(cropperRestoreImage.src);
            return true;
        }

        /* modify the cropperCanvas prototype to allow us to get x and y mouse coords from it */
        HTMLCanvasElement.prototype.getMouseCoords = function(event) {
            // loop through this element and all its parents to get the total offset
            var totalOffsetX = 0;
            var totalOffsetY = 0;
            var canvasX = 0;
            var canvasY = 0;
            var currentElement = this;

            do {
                totalOffsetX += currentElement.offsetLeft;
                totalOffsetY += currentElement.offsetTop;
            }
            while(currentElement = currentElement.offsetParent)

            canvasX = event.pageX - totalOffsetX;
            canvasY = event.pageY - totalOffsetY;

            return {x:canvasX, y:canvasY}
        }

    </script>
</body>
</html>